<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <text class="nav-back" @click="goBack">â†</text>
      <text class="nav-title">æ¶ˆæ¯ä¸­å¿ƒ</text>
      <text class="nav-action" @click="markAllRead">âœ“</text>
    </view>

    <!-- Tabæ ‡ç­¾ -->
    <view class="tabs">
      <view 
        class="tab-item" 
        :class="{ active: activeTab === index }"
        v-for="(tab, index) in tabs" 
        :key="index"
        @click="switchTab(index)"
      >
        <text class="tab-text">{{ tab.name }}</text>
        <view class="tab-badge" v-if="tab.count > 0">{{ tab.count }}</view>
      </view>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view class="message-list">
        <view 
          class="message-item" 
          :class="{ unread: !msg.isRead }"
          v-for="(msg, index) in filteredMessages" 
          :key="index" 
          @click="handleMessageClick(msg)"
        >
          <view class="unread-dot" v-if="!msg.isRead"></view>
          <view class="message-icon" :class="msg.iconClass">
            <text>{{ msg.icon }}</text>
          </view>
          <view class="message-content">
            <view class="message-header">
              <text class="message-title">{{ msg.title }}</text>
              <text class="message-time">{{ msg.time }}</text>
            </view>
            <text class="message-desc">{{ msg.content }}</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" v-if="filteredMessages.length === 0">
        <text class="empty-icon">ğŸ’¬</text>
        <text class="empty-text">æš‚æ— æ¶ˆæ¯</text>
      </view>

      <!-- å ä½ -->
      <view style="height: 180rpx;"></view>
    </scroll-view>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <view class="bottom-nav">
      <view class="nav-item" @click="navigateTo('home')">
        <image class="nav-icon" src="/static/icons/home.png" mode="aspectFit"></image>
        <text class="nav-label">é¦–é¡µ</text>
      </view>
      <view class="nav-item" @click="navigateTo('order')">
        <image class="nav-icon" src="/static/icons/order.png" mode="aspectFit"></image>
        <text class="nav-label">è®¢å•</text>
      </view>
      <view class="fab-button" @click="handleFabClick">
        <text class="fab-icon">+</text>
      </view>
      <view class="nav-item active" @click="navigateTo('message')">
        <image class="nav-icon" src="/static/icons/message-active.png" mode="aspectFit"></image>
        <text class="nav-label">æ¶ˆæ¯</text>
      </view>
      <view class="nav-item" @click="navigateTo('profile')">
        <image class="nav-icon" src="/static/icons/profile.png" mode="aspectFit"></image>
        <text class="nav-label">æˆ‘çš„</text>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'

const activeTab = ref(0)

// Tabæ ‡ç­¾
const tabs = ref([
  { name: 'å…¨éƒ¨æ¶ˆæ¯', type: 'all', count: 5 },
  { name: 'è®¢å•æ¶ˆæ¯', type: 'order', count: 3 },
  { name: 'ç³»ç»Ÿæ¶ˆæ¯', type: 'system', count: 0 }
])

// æ¶ˆæ¯åˆ—è¡¨
const messages = ref([
  {
    id: 1,
    type: 'order',
    icon: 'ğŸ“‹',
    iconClass: 'blue',
    title: 'è®¢å•å·²ç¡®è®¤',
    content: 'æ‚¨çš„è®¢å• OR202511180001 å·²è¢«å·¥ç¨‹å¸ˆç¡®è®¤æ¥å•ï¼Œé¢„è®¡ä»Šå¤©ä¸‹åˆåˆ°è¾¾ç°åœºã€‚',
    time: '10åˆ†é’Ÿå‰',
    isRead: false
  },
  {
    id: 2,
    type: 'order',
    icon: 'ğŸ‘·',
    iconClass: 'green',
    title: 'å·¥ç¨‹å¸ˆå·²åˆ°è¾¾',
    content: 'å·¥ç¨‹å¸ˆå¼ å¸ˆå‚…å·²åˆ°è¾¾ç°åœºå¹¶å®Œæˆå¼€å¡ï¼Œå¼€å§‹ä¸ºæ‚¨æä¾›æœåŠ¡ã€‚',
    time: '1å°æ—¶å‰',
    isRead: false
  },
  {
    id: 3,
    type: 'order',
    icon: 'ğŸ’°',
    iconClass: 'orange',
    title: 'é¢å¤–è´¹ç”¨ç”³è¯·',
    content: 'å·¥ç¨‹å¸ˆç”³è¯·é¢å¤–è´¹ç”¨ Â¥300.00ï¼ŒåŸå› ï¼šéœ€æ›´æ¢æ•…éšœé…ä»¶ã€‚è¯·åŠæ—¶å¤„ç†ã€‚',
    time: '2å°æ—¶å‰',
    isRead: false
  },
  {
    id: 4,
    type: 'system',
    icon: 'ğŸ“¢',
    iconClass: 'red',
    title: 'å¹³å°å…¬å‘Š',
    content: 'ã€é‡è¦é€šçŸ¥ã€‘å¹³å°å°†äºæœ¬å‘¨å…­å‡Œæ™¨2:00-4:00è¿›è¡Œç³»ç»Ÿç»´æŠ¤å‡çº§ï¼ŒæœŸé—´éƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—åˆ°å½±å“ã€‚',
    time: 'æ˜¨å¤© 18:00',
    isRead: true
  },
  {
    id: 5,
    type: 'order',
    icon: 'âœ“',
    iconClass: 'blue',
    title: 'æœåŠ¡å·²å®Œæˆ',
    content: 'è®¢å• OR202511170012 æœåŠ¡å·²å®Œæˆï¼Œè¯·å¯¹æœ¬æ¬¡æœåŠ¡è¿›è¡Œè¯„ä»·ã€‚',
    time: 'æ˜¨å¤© 16:30',
    isRead: true
  },
  {
    id: 6,
    type: 'order',
    icon: 'ğŸ“„',
    iconClass: 'orange',
    title: 'æ”¯ä»˜æˆåŠŸ',
    content: 'æ‚¨å·²æˆåŠŸæ”¯ä»˜è®¢å• OR202511170012ï¼Œé‡‘é¢ Â¥1,200.00ã€‚',
    time: '11-17 14:22',
    isRead: true
  },
  {
    id: 7,
    type: 'system',
    icon: 'ğŸ',
    iconClass: 'green',
    title: 'ä¼˜æƒ åˆ¸åˆ°è´¦',
    content: 'æ­å–œæ‚¨è·å¾—æ–°ç”¨æˆ·ä¸“å±ä¼˜æƒ åˆ¸ï¼šæ»¡500å‡50ï¼Œæœ‰æ•ˆæœŸ30å¤©ã€‚',
    time: '11-16 10:00',
    isRead: true
  },
  {
    id: 8,
    type: 'system',
    icon: 'ğŸ›¡ï¸',
    iconClass: 'red',
    title: 'å®åè®¤è¯å®¡æ ¸é€šè¿‡',
    content: 'æ‚¨çš„å®åè®¤è¯å·²å®¡æ ¸é€šè¿‡ï¼Œç°åœ¨å¯ä»¥äº«å—æ›´å¤šå¹³å°æœåŠ¡ã€‚',
    time: '11-15 09:30',
    isRead: true
  }
])

// è¿‡æ»¤åçš„æ¶ˆæ¯
const filteredMessages = computed(() => {
  const tab = tabs.value[activeTab.value]
  if (tab.type === 'all') {
    return messages.value
  }
  return messages.value.filter(msg => msg.type === tab.type)
})

onMounted(() => {
  loadMessages()
  updateTabCounts()
})

// è¿”å›
function goBack() {
  uni.navigateBack()
}

// åˆ‡æ¢Tab
function switchTab(index: number) {
  activeTab.value = index
}

// åŠ è½½æ¶ˆæ¯
function loadMessages() {
  // TODO: å®é™…åº”ä»åç«¯APIè·å–
  // GET /api/messages
  console.log('åŠ è½½æ¶ˆæ¯åˆ—è¡¨')
}

// æ›´æ–°Tabæœªè¯»æ•°
function updateTabCounts() {
  // å…¨éƒ¨æ¶ˆæ¯æœªè¯»æ•°
  const allUnread = messages.value.filter(msg => !msg.isRead).length
  tabs.value[0].count = allUnread
  
  // è®¢å•æ¶ˆæ¯æœªè¯»æ•°
  const orderUnread = messages.value.filter(msg => msg.type === 'order' && !msg.isRead).length
  tabs.value[1].count = orderUnread
  
  // ç³»ç»Ÿæ¶ˆæ¯æœªè¯»æ•°
  const systemUnread = messages.value.filter(msg => msg.type === 'system' && !msg.isRead).length
  tabs.value[2].count = systemUnread
}

// ç‚¹å‡»æ¶ˆæ¯
function handleMessageClick(msg: any) {
  console.log('ç‚¹å‡»æ¶ˆæ¯:', msg.title)
  
  // æ ‡è®°ä¸ºå·²è¯»
  if (!msg.isRead) {
    msg.isRead = true
    updateTabCounts()
    // TODO: è°ƒç”¨åç«¯APIæ ‡è®°å·²è¯»
    // POST /api/messages/{id}/read
  }
  
  // æ ¹æ®æ¶ˆæ¯ç±»å‹è·³è½¬
  switch (msg.type) {
    case 'order':
      // è·³è½¬åˆ°è®¢å•è¯¦æƒ…
      uni.navigateTo({
        url: `/pages/message/detail?id=${msg.id}`
      })
      break
    case 'service':
      // è·³è½¬åˆ°å®¢æœå¯¹è¯
      uni.navigateTo({
        url: `/pages/chat/service`
      })
      break
    case 'system':
    case 'notice':
      // è·³è½¬åˆ°æ¶ˆæ¯è¯¦æƒ…
      uni.navigateTo({
        url: `/pages/message/detail?id=${msg.id}`
      })
      break
    default:
      uni.showToast({
        title: 'æŸ¥çœ‹æ¶ˆæ¯ï¼š' + msg.title,
        icon: 'none'
      })
  }
}

// å…¨éƒ¨å·²è¯»
function markAllRead() {
  uni.showModal({
    title: 'æ ‡è®°å·²è¯»',
    content: 'ç¡®å®šå°†æ‰€æœ‰æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»å—ï¼Ÿ',
    success: (res) => {
      if (res.confirm) {
        // æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»
        messages.value.forEach(msg => {
          msg.isRead = true
        })
        updateTabCounts()
        
        // TODO: è°ƒç”¨åç«¯APIæ‰¹é‡æ ‡è®°å·²è¯»
        // POST /api/messages/read-all
        
        uni.showToast({
          title: 'å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»',
          icon: 'success'
        })
      }
    }
  })
}

// æ‚¬æµ®æŒ‰é’®
function handleFabClick() {
  uni.navigateTo({
    url: '/pages/order/create'
  })
}

// åº•éƒ¨å¯¼èˆª
function navigateTo(page: string) {
  if (page === 'message') {
    return // å·²ç»åœ¨æ¶ˆæ¯é¡µ
  }
  
  // åº•éƒ¨å¯¼èˆªä½¿ç”¨ reLaunch é¿å…å±‚çº§è¶…é™
  const pageMap: any = {
    'home': '/pages/home/home',
    'order': '/pages/order/order',
    'profile': '/pages/profile/profile'
  }
  
  if (pageMap[page]) {
    uni.reLaunch({
      url: pageMap[page]
    })
  }
}
</script>

<style scoped lang="scss">
.page {
  height: 100vh;
  background-color: #F8F8F8;
  display: flex;
  flex-direction: column;
}

.top-nav {
  background-color: #fff;
  padding: 32rpx 32rpx;
  padding-top: calc(64rpx + env(safe-area-inset-top));
  padding-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1rpx solid #E5E5E5;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
}

.nav-back {
  font-size: 40rpx;
  color: #333;
  width: 60rpx;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #000;
  flex: 1;
  text-align: center;
}

.nav-action {
  font-size: 36rpx;
  color: #666;
  width: 60rpx;
  text-align: right;
}

// Tabæ ‡ç­¾
.tabs {
  background-color: #fff;
  padding: 0 32rpx;
  display: flex;
  flex-direction: row;
  border-bottom: 1rpx solid #E5E5E5;
}

.tab-item {
  flex: 1;
  padding: 24rpx 0;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  position: relative;
}

.tab-item.active {
  color: #F44336;
}

.tab-item.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60rpx;
  height: 6rpx;
  background-color: #F44336;
  border-radius: 3rpx;
}

.tab-text {
  font-size: 30rpx;
  font-weight: 500;
  color: #666;
}

.tab-item.active .tab-text {
  color: #F44336;
  font-weight: 600;
}

.tab-badge {
  min-width: 32rpx;
  height: 32rpx;
  background-color: #F44336;
  border-radius: 16rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 8rpx;
  margin-left: 8rpx;
  font-size: 20rpx;
  color: #fff;
  font-weight: 600;
}

.content-scroll {
  flex: 1;
  padding-top: calc(164rpx + env(safe-area-inset-top));
}

// æ¶ˆæ¯åˆ—è¡¨
.message-list {
  background-color: #fff;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 120rpx 0;
}

.empty-icon {
  font-size: 120rpx;
  margin-bottom: 24rpx;
  opacity: 0.3;
}

.empty-text {
  font-size: 28rpx;
  color: #999;
}

.message-item {
  padding: 28rpx 32rpx;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  position: relative;
  border-bottom: 1rpx solid #F0F0F0;
}

.message-item.unread {
  background-color: #FFF9F0;
}

.message-item:last-child {
  border-bottom: none;
}

.unread-dot {
  position: absolute;
  left: 18rpx;
  top: 50%;
  transform: translateY(-50%);
  width: 12rpx;
  height: 12rpx;
  background-color: #F44336;
  border-radius: 50%;
}

.message-icon {
  width: 88rpx;
  height: 88rpx;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 44rpx;
  flex-shrink: 0;
  margin-right: 24rpx;
  
  &.blue {
    background-color: #5B9FED;
  }
  
  &.green {
    background-color: #52C41A;
  }
  
  &.orange {
    background-color: #FA8C16;
  }
  
  &.red {
    background-color: #F44336;
  }
}

.message-content {
  flex: 1;
  min-width: 0;
}

.message-header {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12rpx;
}

.message-title {
  font-size: 32rpx;
  font-weight: 500;
  color: #000;
  flex: 1;
}

.message-time {
  font-size: 24rpx;
  color: #999;
  white-space: nowrap;
  margin-left: 16rpx;
}

.message-desc {
  font-size: 28rpx;
  color: #666;
  line-height: 1.6;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  border-top: 1rpx solid #f0f0f0;
  display: flex;
  flex-direction: row;
  justify-content: space-around;
  align-items: flex-start;
  padding: 8rpx 0 0;
  padding-bottom: calc(56rpx + env(safe-area-inset-bottom));
  height: 56rpx;
  z-index: 999;
  box-shadow: 0 -2rpx 8rpx rgba(0, 0, 0, 0.06);
  overflow: visible;  /* å…è®¸åœ†å½¢æŒ‰é’®æº¢å‡ºåˆ°å¯¼èˆªæ å¤– */
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4rpx;
  font-size: 22rpx;
  color: #666;
  flex: 1;
  margin-top: 0;
}

.nav-item.active {
  color: #E53935;
}

.nav-item.active .nav-label {
  color: #E53935;
}

.nav-icon {
  width: 44rpx;
  height: 44rpx;
}

.nav-item.active .nav-icon {
  opacity: 1;
}

.nav-item:not(.active) .nav-icon {
  opacity: 0.5;
}

.nav-label {
  font-size: 24rpx;
}

.fab-button {
  width: 112rpx;
  height: 112rpx;
  background: linear-gradient(135deg, #F44336 0%, #E53935 100%);
  border-radius: 50%;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  color: #fff;
  box-shadow: 0 8rpx 24rpx rgba(244, 67, 54, 0.4);
  margin-top: -56rpx;
  position: relative;
  z-index: 1000;
}

.fab-icon {
  font-size: 56rpx;
  color: #fff;
  font-weight: 700;
  line-height: 1;
  transform: translateY(-4rpx);
}
</style>

