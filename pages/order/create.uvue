<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <text class="nav-back" @click="goBack">â†</text>
      <text class="nav-title">å‘å¸ƒå·¥å•</text>
      <view class="nav-placeholder"></view>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- è¡¨å•åŒºåŸŸ -->
      <view class="form-section">
        <text class="section-title">å·¥å•ä¿¡æ¯</text>
        
        <!-- æœåŠ¡ç±»å‹ -->
        <view class="form-item">
          <text class="form-label">æœåŠ¡ç±»å‹</text>
          <picker mode="selector" :range="serviceTypes" range-key="name" @change="onServiceTypeChange">
            <view class="picker-view">
              <text class="picker-text" :class="{ placeholder: !formData.serviceType }">
                {{ formData.serviceType ? serviceTypes[formData.serviceType].name : 'è¯·é€‰æ‹©æœåŠ¡ç±»å‹' }}
              </text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>

        <!-- ä¸šåŠ¡é¢†åŸŸ -->
        <view class="form-item">
          <text class="form-label">ä¸šåŠ¡é¢†åŸŸ</text>
          <picker mode="selector" :range="businessDomains" range-key="name" @change="onDomainChange">
            <view class="picker-view">
              <text class="picker-text" :class="{ placeholder: !formData.domainId }">
                {{ formData.domainId ? businessDomains.find((d: any) => d.id === formData.domainId)?.name : 'è¯·é€‰æ‹©ä¸šåŠ¡é¢†åŸŸ' }}
              </text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>

        <!-- å·¥å•æ ‡é¢˜ -->
        <view class="form-item">
          <text class="form-label">å·¥å•æ ‡é¢˜</text>
          <input 
            class="form-input" 
            v-model="formData.title" 
            placeholder="è¯·ç®€è¦æè¿°æ‚¨çš„éœ€æ±‚"
            placeholder-class="input-placeholder"
            maxlength="50"
          />
        </view>

        <!-- è¯¦ç»†æè¿° -->
        <view class="form-item">
          <text class="form-label">è¯¦ç»†æè¿°</text>
          <textarea 
            class="form-textarea" 
            v-model="formData.description" 
            placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚ã€é—®é¢˜ç°è±¡ç­‰"
            placeholder-class="input-placeholder"
            maxlength="500"
          />
        </view>

        <!-- ä¸Šä¼ å›¾ç‰‡ -->
        <view class="form-item">
          <text class="form-label">ä¸Šä¼ å›¾ç‰‡</text>
          <view class="upload-list">
            <view class="upload-item" v-for="(img, index) in formData.images" :key="index">
              <image class="upload-image" :src="img" mode="aspectFill"></image>
              <view class="delete-btn" @click="deleteImage(index)">Ã—</view>
            </view>
            <view class="upload-box" v-if="formData.images.length < 6" @click="chooseImage">
              <text class="upload-icon">ğŸ“·</text>
              <text class="upload-text">ä¸Šä¼ å›¾ç‰‡</text>
            </view>
          </view>
          <text class="upload-tip">æœ€å¤šä¸Šä¼ 6å¼ å›¾ç‰‡</text>
        </view>

        <!-- æœåŠ¡åœ°å€ -->
        <view class="form-item">
          <text class="form-label">æœåŠ¡åœ°å€</text>
          <view class="address-picker" @click="chooseAddress">
            <text class="address-text" :class="{ placeholder: !formData.address }">
              {{ formData.address || 'è¯·é€‰æ‹©æœåŠ¡åœ°å€' }}
            </text>
            <text class="picker-arrow">â€º</text>
          </view>
        </view>

        <!-- è”ç³»äºº -->
        <view class="form-item">
          <text class="form-label">è”ç³»äºº</text>
          <input 
            class="form-input" 
            v-model="formData.contact" 
            placeholder="è¯·è¾“å…¥è”ç³»äººå§“å"
            placeholder-class="input-placeholder"
          />
        </view>

        <!-- è”ç³»ç”µè¯ -->
        <view class="form-item">
          <text class="form-label">è”ç³»ç”µè¯</text>
          <input 
            class="form-input" 
            v-model="formData.phone" 
            type="number"
            placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
            placeholder-class="input-placeholder"
            maxlength="11"
          />
        </view>

        <!-- æœŸæœ›æœåŠ¡æ—¶é—´ -->
        <view class="form-item">
          <text class="form-label">æœŸæœ›æœåŠ¡æ—¶é—´</text>
          <picker mode="date" @change="onDateChange">
            <view class="picker-view">
              <text class="picker-text" :class="{ placeholder: !formData.serviceDate }">
                {{ formData.serviceDate || 'è¯·é€‰æ‹©æ—¥æœŸ' }}
              </text>
              <text class="picker-arrow">â€º</text>
            </view>
          </picker>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="form-item">
          <text class="form-label">å¤‡æ³¨</text>
          <textarea 
            class="form-textarea" 
            v-model="formData.remark" 
            placeholder="å…¶ä»–è¡¥å……è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"
            placeholder-class="input-placeholder"
            maxlength="200"
          />
        </view>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="submit-section">
        <button class="submit-btn" :class="{ disabled: !canSubmit }" @click="handleSubmit">
          æäº¤å·¥å•
        </button>
      </view>

      <!-- å ä½ -->
      <view style="height: 80rpx;"></view>
    </scroll-view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'

const formData = ref({
  serviceType: 0,
  domainId: 0,
  title: '',
  description: '',
  images: [] as string[],
  address: '',
  contact: '',
  phone: '',
  serviceDate: '',
  remark: ''
})

const serviceTypes = ref([
  { id: 1, name: 'æ‰¾å”®å' },
  { id: 2, name: 'æ‰¾å”®å‰' },
  { id: 3, name: 'æ‰¾å›¢é˜Ÿ' }
])

const businessDomains = ref([
  { id: 1, name: 'å……ç”µæ¡©' },
  { id: 2, name: 'æ™ºæ…§äº¤ç®¡' },
  { id: 3, name: 'æ™ºæ…§å›­åŒº' },
  { id: 4, name: 'æ™ºæ…§ä½“è‚²' },
  { id: 5, name: 'æ™ºæ…§è­¦åŠ¡' },
  { id: 6, name: 'åº”æ€¥æ¶ˆé˜²' },
  { id: 7, name: 'å‡ºå…¥å£é€šé“' },
  { id: 8, name: 'AGVæœºå™¨äºº' },
  { id: 9, name: 'å¤§æ¥¼å¼±ç”µ' }
])

// æ˜¯å¦å¯ä»¥æäº¤
const canSubmit = computed(() => {
  return formData.value.serviceType &&
         formData.value.domainId &&
         formData.value.title &&
         formData.value.description &&
         formData.value.address &&
         formData.value.contact &&
         formData.value.phone &&
         formData.value.serviceDate
})

onMounted(() => {
  // è·å–é¡µé¢å‚æ•°
  const pages = getCurrentPages()
  const currentPage = pages[pages.length - 1] as any
  const options = currentPage.options || {}
  
  // å¦‚æœæœ‰ä¼ å…¥æœåŠ¡ç±»å‹
  if (options.service_type) {
    const serviceTypeIndex = parseInt(options.service_type) - 1
    if (serviceTypeIndex >= 0 && serviceTypeIndex < serviceTypes.value.length) {
      formData.value.serviceType = serviceTypeIndex
    }
  }
  
  // å¦‚æœæœ‰ä¼ å…¥ä¸šåŠ¡é¢†åŸŸID
  if (options.domain_id) {
    const domainId = parseInt(options.domain_id)
    const domain = businessDomains.value.find((d: any) => d.id === domainId)
    if (domain) {
      formData.value.domainId = domainId
    }
  }
  
  // å¦‚æœæœ‰ä¼ å…¥å¤åˆ¶è®¢å•ID
  if (options.copyFrom) {
    // TODO: æ ¹æ®è®¢å•IDåŠ è½½è®¢å•ä¿¡æ¯å¹¶å¡«å……è¡¨å•
    console.log('å¤åˆ¶è®¢å•:', options.copyFrom)
  }
})

// è¿”å›
function goBack() {
  uni.navigateBack()
}

// æœåŠ¡ç±»å‹æ”¹å˜
function onServiceTypeChange(e: any) {
  formData.value.serviceType = e.detail.value
}

// ä¸šåŠ¡é¢†åŸŸæ”¹å˜
function onDomainChange(e: any) {
  const index = e.detail.value
  formData.value.domainId = businessDomains.value[index].id
}

// é€‰æ‹©å›¾ç‰‡
function chooseImage() {
  const remainCount = 6 - formData.value.images.length
  uni.chooseImage({
    count: remainCount,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      formData.value.images.push(...res.tempFilePaths)
    }
  })
}

// åˆ é™¤å›¾ç‰‡
function deleteImage(index: number) {
  formData.value.images.splice(index, 1)
}

// é€‰æ‹©åœ°å€
function chooseAddress() {
  uni.showModal({
    title: 'æç¤º',
    content: 'åœ°å€é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­ï¼ŒV2ç‰ˆæœ¬å°†æ”¯æŒåœ°å›¾é€‰ç‚¹',
    showCancel: false
  })
}

// æ—¥æœŸæ”¹å˜
function onDateChange(e: any) {
  formData.value.serviceDate = e.detail.value
}

// æäº¤å·¥å•
function handleSubmit() {
  if (!canSubmit.value) {
    uni.showToast({
      title: 'è¯·å®Œå–„å·¥å•ä¿¡æ¯',
      icon: 'none'
    })
    return
  }

  // éªŒè¯æ‰‹æœºå·
  if (!/^1[3-9]\d{9}$/.test(formData.value.phone)) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·',
      icon: 'none'
    })
    return
  }

  uni.showModal({
    title: 'ç¡®è®¤æäº¤',
    content: 'ç¡®è®¤æäº¤å·¥å•å—ï¼Ÿæäº¤åå°†ä¸ºæ‚¨åŒ¹é…åˆé€‚çš„å·¥ç¨‹å¸ˆã€‚',
    success: (res) => {
      if (res.confirm) {
        submitOrder()
      }
    }
  })
}

// æäº¤è®¢å•
function submitOrder() {
  uni.showLoading({
    title: 'æäº¤ä¸­...'
  })

  // TODO: å®é™…åº”ä¸Šä¼ å›¾ç‰‡å¹¶è°ƒç”¨åç«¯API
  // POST /api/orders/create
  // {
  //   service_type: formData.value.serviceType,
  //   domain_id: formData.value.domainId,
  //   title: formData.value.title,
  //   description: formData.value.description,
  //   images: [...], // å›¾ç‰‡URLæ•°ç»„
  //   address: formData.value.address,
  //   contact: formData.value.contact,
  //   phone: formData.value.phone,
  //   service_date: formData.value.serviceDate,
  //   remark: formData.value.remark
  // }

  setTimeout(() => {
    uni.hideLoading()
    uni.showModal({
      title: 'æäº¤æˆåŠŸ',
      content: 'å·¥å•å·²æäº¤ï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨åŒ¹é…å·¥ç¨‹å¸ˆã€‚',
      showCancel: false,
      success: () => {
        // è·³è½¬åˆ°è®¢å•åˆ—è¡¨
        uni.reLaunch({
          url: '/pages/order/order'
        })
      }
    })
  }, 2000)
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background-color: #F5F5F5;
  display: flex;
  flex-direction: column;
}

.top-nav {
  background: #FFFFFF;
  padding: 32rpx 32rpx;
  padding-top: calc(64rpx + env(safe-area-inset-top));
  padding-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1rpx solid #F0F0F0;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
}

.nav-back {
  font-size: 44rpx;
  color: #333;
  width: 80rpx;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  flex: 1;
  text-align: center;
}

.nav-placeholder {
  width: 80rpx;
}

.content-scroll {
  flex: 1;
  padding-top: calc(144rpx + env(safe-area-inset-top));
}

.form-section {
  background: #FFFFFF;
  margin: 24rpx 32rpx;
  padding: 32rpx;
  border-radius: 16rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 32rpx;
}

.form-item {
  margin-bottom: 32rpx;
}

.form-label {
  display: block;
  font-size: 28rpx;
  font-weight: 500;
  color: #333;
  margin-bottom: 16rpx;
}

.form-input {
  width: 100%;
  background: #F5F5F5;
  padding: 24rpx;
  border-radius: 12rpx;
  font-size: 28rpx;
  color: #333;
}

.form-textarea {
  width: 100%;
  background: #F5F5F5;
  padding: 24rpx;
  border-radius: 12rpx;
  font-size: 28rpx;
  color: #333;
  min-height: 200rpx;
}

.input-placeholder {
  color: #BDBDBD;
}

.picker-view {
  background: #F5F5F5;
  padding: 24rpx;
  border-radius: 12rpx;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.picker-text {
  font-size: 28rpx;
  color: #333;
  
  &.placeholder {
    color: #BDBDBD;
  }
}

.picker-arrow {
  font-size: 44rpx;
  color: #BDBDBD;
}

// ä¸Šä¼ å›¾ç‰‡
.upload-list {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 16rpx;
}

.upload-item {
  width: 200rpx;
  height: 200rpx;
  position: relative;
  border-radius: 12rpx;
  overflow: hidden;
}

.upload-image {
  width: 100%;
  height: 100%;
}

.delete-btn {
  position: absolute;
  top: 8rpx;
  right: 8rpx;
  width: 48rpx;
  height: 48rpx;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #FFFFFF;
  font-size: 36rpx;
  line-height: 1;
}

.upload-box {
  width: 200rpx;
  height: 200rpx;
  background: #F5F5F5;
  border: 2rpx dashed #D9D9D9;
  border-radius: 12rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12rpx;
}

.upload-icon {
  font-size: 48rpx;
  opacity: 0.5;
}

.upload-text {
  font-size: 24rpx;
  color: #999;
}

.upload-tip {
  display: block;
  font-size: 24rpx;
  color: #999;
  margin-top: 16rpx;
}

.address-picker {
  background: #F5F5F5;
  padding: 24rpx;
  border-radius: 12rpx;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.address-text {
  flex: 1;
  font-size: 28rpx;
  color: #333;
  
  &.placeholder {
    color: #BDBDBD;
  }
}

// æäº¤æŒ‰é’®
.submit-section {
  padding: 0 32rpx;
}

.submit-btn {
  width: 100%;
  background: linear-gradient(135deg, #F44336 0%, #E53935 100%);
  color: #FFFFFF;
  padding: 28rpx;
  border-radius: 48rpx;
  font-size: 32rpx;
  font-weight: 600;
  border: none;
  box-shadow: 0 8rpx 24rpx rgba(244, 67, 54, 0.3);
}

.submit-btn.disabled {
  background: #BDBDBD;
  box-shadow: none;
  opacity: 0.6;
}
</style>

