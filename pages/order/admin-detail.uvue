<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <view class="nav-back" @click="goBack">
        <text class="back-icon">â†</text>
      </view>
      <text class="nav-title">è®¢å•ç®¡ç† - è¯¦æƒ…</text>
      <view class="nav-placeholder"></view>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- è®¢å•çŠ¶æ€æµç¨‹ -->
      <view class="status-section">
        <view class="section-header">
          <text class="section-title">è®¢å•çŠ¶æ€æµç¨‹</text>
          <view class="status-badge" :class="'badge-' + currentStatus">
            {{ statusText }}
          </view>
        </view>
        
        <view class="status-timeline">
          <view 
            class="timeline-item" 
            v-for="(item, index) in statusTimeline" 
            :key="index"
            :class="{ 
              active: item.status <= currentStatus, 
              current: item.status === currentStatus,
              rejected: item.status === 9 && currentStatus === 9
            }"
          >
            <view class="timeline-dot">
              <text class="dot-icon" v-if="item.status < currentStatus">âœ“</text>
              <text class="dot-icon" v-else-if="item.status === currentStatus && currentStatus !== 9">â—</text>
              <text class="dot-icon" v-else-if="item.status === 9 && currentStatus === 9">âœ•</text>
            </view>
            <view class="timeline-content">
              <text class="timeline-title">{{ item.name }}</text>
              <text class="timeline-time" v-if="item.time">{{ item.time }}</text>
              <text class="timeline-operator" v-if="item.operator">æ“ä½œäºº: {{ item.operator }}</text>
              <text class="timeline-desc" v-if="item.desc">{{ item.desc }}</text>
            </view>
            <view class="timeline-line" v-if="index < statusTimeline.length - 1"></view>
          </view>
        </view>
      </view>

      <!-- åå°ç®¡ç†æ“ä½œåŒº -->
      <view class="admin-actions-section" v-if="showAdminActions">
        <view class="section-title">åå°ç®¡ç†æ“ä½œ</view>
        
        <!-- å¾…ä»˜æ¬¾çŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 1">
          <view class="card-title">ç¼–è¾‘æ ¸ç®—é‡‘é¢</view>
          <view class="form-row">
            <text class="form-label">è®¢å•é‡‘é¢</text>
            <input 
              class="form-input" 
              type="digit" 
              v-model="editPrice" 
              placeholder="è¯·è¾“å…¥é‡‘é¢"
            />
            <text class="form-unit">å…ƒ</text>
          </view>
          <button class="admin-btn primary" @click="updatePrice">ä¿å­˜é‡‘é¢</button>
          <button class="admin-btn secondary" @click="sendPaymentReminder">å‚¬ä»˜æé†’</button>
        </view>

        <!-- å·²ä»˜æ¬¾(å¾…æ¥å•)çŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 2">
          <view class="card-title">åˆ†é…å·¥ç¨‹å¸ˆ</view>
          <view class="engineer-pool">
            <text class="pool-tip">å½“å‰æ¥å•æ± ä¸­æœ‰ {{ engineerPool.length }} ä½å·¥ç¨‹å¸ˆ</text>
            <button class="admin-btn" @click="viewEngineerPool">æŸ¥çœ‹æ¥å•æ± </button>
          </view>
          <view class="form-row">
            <text class="form-label">æ‰‹åŠ¨åˆ†é…</text>
            <picker mode="selector" :range="engineerList" range-key="name" @change="onEngineerChange">
              <view class="picker-value">
                {{ selectedEngineer ? selectedEngineer.name : 'é€‰æ‹©å·¥ç¨‹å¸ˆ' }}
              </view>
            </picker>
          </view>
          <button class="admin-btn primary" @click="assignEngineer" :disabled="!selectedEngineer">
            ç¡®è®¤åˆ†é…
          </button>
        </view>

        <!-- å·¥ç¨‹å¸ˆæ¥å•ä¸­çŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 3">
          <view class="card-title">æ¥å•ç®¡ç†</view>
          <view class="info-row">
            <text class="info-label">æ¥å•å·¥ç¨‹å¸ˆ</text>
            <text class="info-value">{{ orderInfo.engineerName }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ¥å•æ—¶é—´</text>
            <text class="info-value">{{ orderInfo.acceptTime }}</text>
          </view>
          <button class="admin-btn" @click="viewCommunication">æŸ¥çœ‹æ²Ÿé€šè®°å½•</button>
          <button class="admin-btn secondary" @click="interveneOrder">ä»‹å…¥åè°ƒ</button>
        </view>

        <!-- æ²Ÿé€šä¸­çŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 4">
          <view class="card-title">æ²Ÿé€šç›‘æ§</view>
          <view class="info-row">
            <text class="info-label">æ²Ÿé€šçŠ¶æ€</text>
            <text class="info-value">{{ communicationStatus }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æœ€åæ²Ÿé€š</text>
            <text class="info-value">{{ lastCommunicationTime }}</text>
          </view>
          <button class="admin-btn" @click="viewCommunication">æŸ¥çœ‹æ²Ÿé€šè¯¦æƒ…</button>
          <button class="admin-btn secondary" @click="remindSign">æé†’ç­¾çº¦</button>
        </view>

        <!-- å¾…å®¡æ ¸(ç­¾çº¦å)çŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 5">
          <view class="card-title">ç­¾çº¦å®¡æ ¸</view>
          <view class="contract-info">
            <view class="info-row">
              <text class="info-label">ç­¾çº¦è´¹ç”¨</text>
              <text class="info-value">ï¿¥{{ contractInfo.fee }}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æœåŠ¡æ—¶é—´</text>
              <text class="info-value">{{ contractInfo.serviceTime }}</text>
            </view>
            <view class="info-row">
              <text class="info-label">ç­¾çº¦åŒæ–¹</text>
              <text class="info-value">{{ orderInfo.customerName }} & {{ orderInfo.engineerName }}</text>
            </view>
          </view>
          <view class="contract-file" @click="viewContract">
            <text class="file-icon">ğŸ“„</text>
            <text class="file-name">ç”µå­åˆåŒ.pdf</text>
            <text class="file-action">æŸ¥çœ‹</text>
          </view>
          <view class="audit-actions">
            <button class="admin-btn primary" @click="approveContract">å®¡æ ¸é€šè¿‡</button>
            <button class="admin-btn danger" @click="rejectContract">é©³å›</button>
          </view>
        </view>

        <!-- å·²å®ŒæˆçŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 7">
          <view class="card-title">è®¢å•å½’æ¡£</view>
          <view class="info-row">
            <text class="info-label">å®Œæˆæ—¶é—´</text>
            <text class="info-value">{{ orderInfo.completeTime }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">è®¢å•æ•°æ®</text>
            <text class="info-value">å®Œæ•´</text>
          </view>
          <button class="admin-btn" @click="generateReport">ç”ŸæˆæœåŠ¡æŠ¥å‘Š</button>
          <button class="admin-btn" @click="exportData">å¯¼å‡ºè®¢å•æ•°æ®</button>
        </view>

        <!-- å·²é©³å›çŠ¶æ€ -->
        <view class="action-card" v-if="currentStatus === 9">
          <view class="card-title">é©³å›å¤„ç†</view>
          <view class="reject-info">
            <text class="reject-label">é©³å›åŸå› :</text>
            <text class="reject-reason">{{ rejectReason }}</text>
          </view>
          <button class="admin-btn" @click="viewCommunication">æŸ¥çœ‹æ²Ÿé€šè®°å½•</button>
          <button class="admin-btn primary" @click="reopenOrder">é‡æ–°æ‰“å¼€è®¢å•</button>
        </view>
      </view>

      <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
      <view class="info-section">
        <view class="section-title">è®¢å•åŸºæœ¬ä¿¡æ¯</view>
        <view class="info-card">
          <view class="info-row">
            <text class="info-label">è®¢å•ç¼–å·</text>
            <text class="info-value selectable">{{ orderInfo.orderNo }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æœåŠ¡ç±»å‹</text>
            <text class="info-value">{{ orderInfo.serviceType }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æœåŠ¡æ ‡é¢˜</text>
            <text class="info-value">{{ orderInfo.title }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">éœ€æ±‚æè¿°</text>
            <text class="info-value multi-line">{{ orderInfo.description }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æœåŠ¡åœ°å€</text>
            <text class="info-value multi-line">{{ orderInfo.address }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">é¢„çº¦æ—¶é—´</text>
            <text class="info-value">{{ orderInfo.appointmentTime }}</text>
          </view>
          <view class="info-row highlight">
            <text class="info-label">è®¢å•é‡‘é¢</text>
            <text class="info-value price">ï¿¥{{ orderInfo.price }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">åˆ›å»ºæ—¶é—´</text>
            <text class="info-value">{{ orderInfo.createTime }}</text>
          </view>
        </view>
      </view>

      <!-- å®¢æˆ·ä¿¡æ¯ -->
      <view class="info-section">
        <view class="section-title">å®¢æˆ·ä¿¡æ¯</view>
        <view class="info-card">
          <view class="customer-header">
            <image class="avatar" :src="orderInfo.customerAvatar || '/static/icons/avatar-default.png'" mode="aspectFill"></image>
            <view class="customer-info">
              <text class="customer-name">{{ orderInfo.customerName }}</text>
              <text class="customer-phone">{{ orderInfo.customerPhone }}</text>
            </view>
            <button class="contact-btn" @click="contactCustomer">è”ç³»</button>
          </view>
          <view class="info-row">
            <text class="info-label">ä»˜æ¬¾å‡­è¯</text>
            <text class="info-value link" @click="viewPaymentProof">æŸ¥çœ‹å‡­è¯</text>
          </view>
          <view class="info-row">
            <text class="info-label">å‘èµ·æ—¶é—´</text>
            <text class="info-value">{{ orderInfo.createTime }}</text>
          </view>
        </view>
      </view>

      <!-- å·¥ç¨‹å¸ˆä¿¡æ¯ -->
      <view class="info-section" v-if="orderInfo.engineerName">
        <view class="section-title">å·¥ç¨‹å¸ˆä¿¡æ¯</view>
        <view class="info-card">
          <view class="engineer-header">
            <image class="avatar" :src="orderInfo.engineerAvatar || '/static/icons/avatar-default.png'" mode="aspectFill"></image>
            <view class="engineer-info">
              <text class="engineer-name">{{ orderInfo.engineerName }}</text>
              <view class="engineer-tags">
                <text class="tag" v-for="(tag, index) in orderInfo.engineerTags" :key="index">{{ tag }}</text>
              </view>
            </view>
            <button class="contact-btn" @click="contactEngineer">è”ç³»</button>
          </view>
          <view class="info-row">
            <text class="info-label">è”ç³»ç”µè¯</text>
            <text class="info-value">{{ orderInfo.engineerPhone }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ¥å•æ—¶é—´</text>
            <text class="info-value">{{ orderInfo.acceptTime }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æŠ€èƒ½æ ‡ç­¾</text>
            <text class="info-value">{{ orderInfo.engineerTags.join('ã€') }}</text>
          </view>
        </view>
      </view>

      <!-- æ²Ÿé€šè®°å½• -->
      <view class="info-section" v-if="communicationLogs.length > 0">
        <view class="section-title">æ²Ÿé€šè®°å½•</view>
        <view class="info-card">
          <view class="comm-item" v-for="(log, index) in communicationLogs" :key="index">
            <view class="comm-header">
              <text class="comm-user">{{ log.userName }}</text>
              <text class="comm-role">{{ log.role }}</text>
              <text class="comm-time">{{ log.time }}</text>
            </view>
            <text class="comm-content">{{ log.content }}</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæ—¥å¿— -->
      <view class="info-section">
        <view class="section-title">æ“ä½œæ—¥å¿—</view>
        <view class="info-card">
          <view class="log-item" v-for="(log, index) in operationLogs" :key="index">
            <view class="log-dot"></view>
            <view class="log-content">
              <text class="log-text">{{ log.content }}</text>
              <text class="log-time">{{ log.time }}</text>
              <text class="log-operator" v-if="log.operator">æ“ä½œäºº: {{ log.operator }} ({{ log.operatorRole }})</text>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨å ä½ -->
      <view style="height: 100rpx;"></view>
    </scroll-view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'

// è®¢å•ID
const orderId = ref('')

// å½“å‰è®¢å•çŠ¶æ€
const currentStatus = ref(2) // ç¤ºä¾‹: 2=å·²ä»˜æ¬¾(å¾…æ¥å•)

// çŠ¶æ€æ–‡æœ¬
const statusText = computed(() => {
  const statusMap: any = {
    1: 'å¾…ä»˜æ¬¾',
    2: 'å·²ä»˜æ¬¾(å¾…æ¥å•)',
    3: 'å·²æ¥å•(å¾…ç­¾çº¦)',
    4: 'æ²Ÿé€šä¸­',
    5: 'å¾…å®¡æ ¸(ç­¾çº¦å)',
    6: 'å¾…æœåŠ¡',
    7: 'å·²å®Œæˆ',
    8: 'å”®åä¸­',
    9: 'å·²é©³å›'
  }
  return statusMap[currentStatus.value] || ''
})

// æ˜¯å¦æ˜¾ç¤ºåå°ç®¡ç†æ“ä½œ
const showAdminActions = ref(true)

// ç¼–è¾‘é‡‘é¢
const editPrice = ref('1200.00')

// å·¥ç¨‹å¸ˆæ¥å•æ± 
const engineerPool = ref([
  { id: 1, name: 'æå·¥', skills: ['å®¶ç”µç»´ä¿®', 'å¼±ç”µå·¥ç¨‹'] },
  { id: 2, name: 'å¼ å·¥', skills: ['å……ç”µæ¡©å®‰è£…', 'ç”µæ°”å·¥ç¨‹'] },
  { id: 3, name: 'ç‹å·¥', skills: ['æ™ºèƒ½å®¶å±…', 'ç½‘ç»œå¸ƒçº¿'] }
])

// å·¥ç¨‹å¸ˆåˆ—è¡¨
const engineerList = ref([
  { id: 1, name: 'æå·¥', skills: ['å®¶ç”µç»´ä¿®', 'å¼±ç”µå·¥ç¨‹'] },
  { id: 2, name: 'å¼ å·¥', skills: ['å……ç”µæ¡©å®‰è£…', 'ç”µæ°”å·¥ç¨‹'] },
  { id: 3, name: 'ç‹å·¥', skills: ['æ™ºèƒ½å®¶å±…', 'ç½‘ç»œå¸ƒçº¿'] },
  { id: 4, name: 'èµµå·¥', skills: ['æ¶ˆé˜²å·¥ç¨‹', 'å®‰é˜²ç›‘æ§'] }
])

// é€‰ä¸­çš„å·¥ç¨‹å¸ˆ
const selectedEngineer = ref(null as any)

// æ²Ÿé€šçŠ¶æ€
const communicationStatus = ref('è¿›è¡Œä¸­')
const lastCommunicationTime = ref('2025-01-19 10:42')

// åˆåŒä¿¡æ¯
const contractInfo = ref({
  fee: '1200.00',
  serviceTime: '2025-01-20 14:00 - 16:00'
})

// é©³å›åŸå› 
const rejectReason = ref('å·¥ç¨‹å¸ˆèµ„è´¨ä¸ç¬¦åˆè¦æ±‚,éœ€è¦é‡æ–°åˆ†é…')

// è®¢å•åŸºæœ¬ä¿¡æ¯
const orderInfo = ref({
  orderNo: 'ORD202501190002',
  serviceType: 'å”®å‰æœåŠ¡',
  title: 'å……ç”µæ¡©å®‰è£…æ–¹æ¡ˆå’¨è¯¢',
  description: 'éœ€è¦ä¸“ä¸šå·¥ç¨‹å¸ˆè¯„ä¼°ç°åœºï¼Œæä¾›å……ç”µæ¡©å®‰è£…æ–¹æ¡ˆ',
  address: 'æ‰¬å·å¸‚å¹¿é™µåŒºå•†ä¸šå¹¿åœºåœè½¦åœºBåŒº',
  appointmentTime: '2025-01-20 14:00',
  price: '1200.00',
  customerName: 'å¼ å…ˆç”Ÿ',
  customerPhone: '138****5678',
  customerAvatar: '',
  engineerName: '',
  engineerAvatar: '',
  engineerTags: [],
  engineerPhone: '',
  acceptTime: '',
  completeTime: '',
  createTime: '2025-01-18 15:20'
})

// è®¢å•çŠ¶æ€æ—¶é—´è½´
const statusTimeline = computed(() => {
  const timeline = [
    {
      status: 1,
      name: 'å¾…ä»˜æ¬¾',
      time: orderInfo.value.createTime,
      operator: orderInfo.value.customerName,
      desc: 'å®¢æˆ·å‘èµ·è®¢å•'
    },
    {
      status: 2,
      name: 'å·²ä»˜æ¬¾(å¾…æ¥å•)',
      time: currentStatus.value >= 2 ? '2025-01-19 09:00' : '',
      operator: currentStatus.value >= 2 ? orderInfo.value.customerName : '',
      desc: currentStatus.value >= 2 ? 'ç­‰å¾…å·¥ç¨‹å¸ˆæ¥å•' : ''
    },
    {
      status: 3,
      name: 'å·²æ¥å•(å¾…ç­¾çº¦)',
      time: currentStatus.value >= 3 ? orderInfo.value.acceptTime : '',
      operator: currentStatus.value >= 3 ? orderInfo.value.engineerName : '',
      desc: currentStatus.value >= 3 ? 'å·¥ç¨‹å¸ˆå·²æ¥å•' : ''
    },
    {
      status: 4,
      name: 'æ²Ÿé€šä¸­',
      time: currentStatus.value >= 4 ? '2025-01-19 10:35' : '',
      operator: currentStatus.value >= 4 ? 'åŒæ–¹' : '',
      desc: currentStatus.value >= 4 ? 'å·¥ç¨‹å¸ˆä¸å®¢æˆ·æ²Ÿé€šæœåŠ¡ç»†èŠ‚' : ''
    },
    {
      status: 5,
      name: 'å¾…å®¡æ ¸(ç­¾çº¦å)',
      time: currentStatus.value >= 5 ? '2025-01-19 15:00' : '',
      operator: currentStatus.value >= 5 ? 'åŒæ–¹' : '',
      desc: currentStatus.value >= 5 ? 'ç­‰å¾…åå°å®¡æ ¸åˆåŒ' : ''
    },
    {
      status: 6,
      name: 'å¾…æœåŠ¡',
      time: currentStatus.value >= 6 ? '2025-01-19 16:00' : '',
      operator: currentStatus.value >= 6 ? 'åå°ç®¡ç†å‘˜' : '',
      desc: currentStatus.value >= 6 ? 'å®¡æ ¸é€šè¿‡,ç­‰å¾…æœåŠ¡' : ''
    },
    {
      status: 7,
      name: 'å·²å®Œæˆ',
      time: currentStatus.value >= 7 ? orderInfo.value.completeTime : '',
      operator: currentStatus.value >= 7 ? orderInfo.value.customerName : '',
      desc: currentStatus.value >= 7 ? 'è®¢å•å·²å®Œæˆ' : ''
    }
  ]

  // å¦‚æœè®¢å•è¢«é©³å›
  if (currentStatus.value === 9) {
    return [
      ...timeline.slice(0, 5),
      {
        status: 9,
        name: 'å·²é©³å›',
        time: '2025-01-19 16:00',
        operator: 'åå°ç®¡ç†å‘˜',
        desc: rejectReason.value
      }
    ]
  }

  return timeline
})

// æ²Ÿé€šè®°å½•
const communicationLogs = ref([
  {
    userName: 'æå·¥',
    role: 'å·¥ç¨‹å¸ˆ',
    time: '2025-01-19 10:35',
    content: 'æ‚¨å¥½,æˆ‘å·²æ¥å•,æ˜å¤©ä¸‹åˆ2ç‚¹å¯ä»¥åˆ°ç°åœºå‹˜å¯Ÿ,æ‚¨çœ‹æ–¹ä¾¿å—?'
  },
  {
    userName: 'å¼ å…ˆç”Ÿ',
    role: 'å®¢æˆ·',
    time: '2025-01-19 10:40',
    content: 'å¯ä»¥çš„,æ˜å¤©ä¸‹åˆ2ç‚¹è§ã€‚'
  },
  {
    userName: 'æå·¥',
    role: 'å·¥ç¨‹å¸ˆ',
    time: '2025-01-19 10:42',
    content: 'å¥½çš„,æˆ‘ä¼šå‡†æ—¶åˆ°è¾¾,è¯·ä¿æŒç”µè¯ç•…é€šã€‚'
  }
])

// æ“ä½œæ—¥å¿—
const operationLogs = ref([
  {
    content: 'è®¢å•è¿›å…¥æ¥å•æ± ',
    time: '2025-01-19 09:00',
    operator: 'ç³»ç»Ÿ',
    operatorRole: 'è‡ªåŠ¨'
  },
  {
    content: 'è®¢å•æ”¯ä»˜æˆåŠŸ',
    time: '2025-01-19 09:00',
    operator: 'å¼ å…ˆç”Ÿ',
    operatorRole: 'å®¢æˆ·'
  },
  {
    content: 'åå°æ ¸ç®—é‡‘é¢: ï¿¥1200.00',
    time: '2025-01-18 16:00',
    operator: 'ç®¡ç†å‘˜A',
    operatorRole: 'åå°'
  },
  {
    content: 'è®¢å•åˆ›å»ºæˆåŠŸ',
    time: '2025-01-18 15:20',
    operator: 'å¼ å…ˆç”Ÿ',
    operatorRole: 'å®¢æˆ·'
  }
])

onMounted(() => {
  // è·å–é¡µé¢å‚æ•°
  const pages = getCurrentPages()
  const currentPage = pages[pages.length - 1] as any
  const options = currentPage.options || {}
  
  orderId.value = options.id || ''
  
  // åŠ è½½è®¢å•è¯¦æƒ…
  loadOrderDetail()
})

// åŠ è½½è®¢å•è¯¦æƒ…
function loadOrderDetail() {
  // TODO: ä»åç«¯APIè·å–è®¢å•è¯¦æƒ…
  console.log('åŠ è½½è®¢å•è¯¦æƒ…:', orderId.value)
}

// è¿”å›
function goBack() {
  uni.navigateBack()
}

// ========== åå°ç®¡ç†æ“ä½œ ==========

// æ›´æ–°é‡‘é¢
function updatePrice() {
  if (!editPrice.value || parseFloat(editPrice.value) <= 0) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢',
      icon: 'none'
    })
    return
  }
  
  uni.showModal({
    title: 'ç¡®è®¤ä¿®æ”¹',
    content: `å°†è®¢å•é‡‘é¢ä¿®æ”¹ä¸º ï¿¥${editPrice.value}?`,
    success: (res) => {
      if (res.confirm) {
        // TODO: è°ƒç”¨APIæ›´æ–°é‡‘é¢
        uni.showToast({
          title: 'é‡‘é¢å·²æ›´æ–°',
          icon: 'success'
        })
        orderInfo.value.price = editPrice.value
      }
    }
  })
}

// å‘é€å‚¬ä»˜æé†’
function sendPaymentReminder() {
  uni.showModal({
    title: 'å‘é€å‚¬ä»˜æé†’',
    content: 'ç¡®å®šå‘å®¢æˆ·å‘é€æ”¯ä»˜æé†’æ¶ˆæ¯?',
    success: (res) => {
      if (res.confirm) {
        // TODO: è°ƒç”¨APIå‘é€æé†’
        uni.showToast({
          title: 'æé†’å·²å‘é€',
          icon: 'success'
        })
      }
    }
  })
}

// æŸ¥çœ‹æ¥å•æ± 
function viewEngineerPool() {
  uni.showModal({
    title: 'æ¥å•æ± ',
    content: `å½“å‰æœ‰ ${engineerPool.value.length} ä½å·¥ç¨‹å¸ˆåœ¨æ¥å•æ± ä¸­ç­‰å¾…æ¥å•`,
    showCancel: false
  })
}

// é€‰æ‹©å·¥ç¨‹å¸ˆ
function onEngineerChange(e: any) {
  const index = e.detail.value
  selectedEngineer.value = engineerList.value[index]
}

// åˆ†é…å·¥ç¨‹å¸ˆ
function assignEngineer() {
  if (!selectedEngineer.value) {
    uni.showToast({
      title: 'è¯·é€‰æ‹©å·¥ç¨‹å¸ˆ',
      icon: 'none'
    })
    return
  }
  
  uni.showModal({
    title: 'ç¡®è®¤åˆ†é…',
    content: `å°†è®¢å•åˆ†é…ç»™ ${selectedEngineer.value.name}?`,
    success: (res) => {
      if (res.confirm) {
        // TODO: è°ƒç”¨APIåˆ†é…å·¥ç¨‹å¸ˆ
        uni.showToast({
          title: 'åˆ†é…æˆåŠŸ',
          icon: 'success'
        })
        orderInfo.value.engineerName = selectedEngineer.value.name
        orderInfo.value.engineerTags = selectedEngineer.value.skills
        currentStatus.value = 3
      }
    }
  })
}

// æŸ¥çœ‹æ²Ÿé€šè®°å½•
function viewCommunication() {
  uni.showToast({
    title: 'æŸ¥çœ‹æ²Ÿé€šè®°å½•',
    icon: 'none'
  })
}

// ä»‹å…¥åè°ƒ
function interveneOrder() {
  uni.showModal({
    title: 'ä»‹å…¥åè°ƒ',
    content: 'ç¡®å®šè¦ä»‹å…¥æ­¤è®¢å•çš„åè°ƒå—?',
    success: (res) => {
      if (res.confirm) {
        uni.showToast({
          title: 'å·²ä»‹å…¥è®¢å•',
          icon: 'success'
        })
      }
    }
  })
}

// æé†’ç­¾çº¦
function remindSign() {
  uni.showModal({
    title: 'æé†’ç­¾çº¦',
    content: 'å‘åŒæ–¹å‘é€ç­¾çº¦æé†’?',
    success: (res) => {
      if (res.confirm) {
        uni.showToast({
          title: 'æé†’å·²å‘é€',
          icon: 'success'
        })
      }
    }
  })
}

// æŸ¥çœ‹åˆåŒ
function viewContract() {
  uni.showToast({
    title: 'æŸ¥çœ‹ç”µå­åˆåŒ',
    icon: 'none'
  })
}

// å®¡æ ¸é€šè¿‡
function approveContract() {
  uni.showModal({
    title: 'å®¡æ ¸é€šè¿‡',
    content: 'ç¡®è®¤å®¡æ ¸é€šè¿‡æ­¤åˆåŒ?',
    success: (res) => {
      if (res.confirm) {
        // TODO: è°ƒç”¨APIå®¡æ ¸é€šè¿‡
        uni.showToast({
          title: 'å®¡æ ¸é€šè¿‡',
          icon: 'success'
        })
        currentStatus.value = 6
      }
    }
  })
}

// é©³å›åˆåŒ
function rejectContract() {
  uni.showPrompt({
    title: 'é©³å›åˆåŒ',
    content: 'è¯·è¾“å…¥é©³å›åŸå› ',
    placeholderText: 'è¯·å¡«å†™é©³å›åŸå› ',
    success: (res) => {
      if (res.confirm && res.content) {
        // TODO: è°ƒç”¨APIé©³å›
        uni.showToast({
          title: 'å·²é©³å›',
          icon: 'success'
        })
        rejectReason.value = res.content
        currentStatus.value = 9
      }
    }
  } as any)
}

// ç”ŸæˆæœåŠ¡æŠ¥å‘Š
function generateReport() {
  uni.showLoading({
    title: 'ç”Ÿæˆä¸­...'
  })
  
  setTimeout(() => {
    uni.hideLoading()
    uni.showToast({
      title: 'æŠ¥å‘Šå·²ç”Ÿæˆ',
      icon: 'success'
    })
  }, 2000)
}

// å¯¼å‡ºè®¢å•æ•°æ®
function exportData() {
  uni.showLoading({
    title: 'å¯¼å‡ºä¸­...'
  })
  
  setTimeout(() => {
    uni.hideLoading()
    uni.showToast({
      title: 'æ•°æ®å·²å¯¼å‡º',
      icon: 'success'
    })
  }, 2000)
}

// é‡æ–°æ‰“å¼€è®¢å•
function reopenOrder() {
  uni.showModal({
    title: 'é‡æ–°æ‰“å¼€è®¢å•',
    content: 'ç¡®å®šè¦é‡æ–°æ‰“å¼€æ­¤è®¢å•,å›åˆ°"æ²Ÿé€šä¸­"çŠ¶æ€?',
    success: (res) => {
      if (res.confirm) {
        // TODO: è°ƒç”¨APIé‡æ–°æ‰“å¼€
        uni.showToast({
          title: 'è®¢å•å·²é‡æ–°æ‰“å¼€',
          icon: 'success'
        })
        currentStatus.value = 4
      }
    }
  })
}

// è”ç³»å®¢æˆ·
function contactCustomer() {
  uni.showActionSheet({
    itemList: ['æ‹¨æ‰“ç”µè¯', 'å‘é€æ¶ˆæ¯', 'å–æ¶ˆ'],
    success: (res) => {
      if (res.tapIndex === 0) {
        uni.makePhoneCall({
          phoneNumber: orderInfo.value.customerPhone.replace(/\*/g, '1')
        })
      } else if (res.tapIndex === 1) {
        uni.showToast({
          title: 'æ¶ˆæ¯åŠŸèƒ½å¼€å‘ä¸­',
          icon: 'none'
        })
      }
    }
  })
}

// è”ç³»å·¥ç¨‹å¸ˆ
function contactEngineer() {
  uni.showActionSheet({
    itemList: ['æ‹¨æ‰“ç”µè¯', 'å‘é€æ¶ˆæ¯', 'å–æ¶ˆ'],
    success: (res) => {
      if (res.tapIndex === 0) {
        uni.makePhoneCall({
          phoneNumber: orderInfo.value.engineerPhone.replace(/\*/g, '1')
        })
      } else if (res.tapIndex === 1) {
        uni.showToast({
          title: 'æ¶ˆæ¯åŠŸèƒ½å¼€å‘ä¸­',
          icon: 'none'
        })
      }
    }
  })
}

// æŸ¥çœ‹ä»˜æ¬¾å‡­è¯
function viewPaymentProof() {
  uni.showToast({
    title: 'æŸ¥çœ‹ä»˜æ¬¾å‡­è¯',
    icon: 'none'
  })
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background-color: #F5F5F5;
  padding-bottom: 40rpx;
}

/* é¡¶éƒ¨å¯¼èˆª */
.top-nav {
  background-color: #fff;
  padding: 32rpx 32rpx;
  padding-top: calc(64rpx + env(safe-area-inset-top));
  padding-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1rpx solid #f0f0f0;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
}

.nav-back {
  width: 60rpx;
}

.back-icon {
  font-size: 44rpx;
  color: #333;
  font-weight: 600;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 700;
  color: #333;
  flex: 1;
  text-align: center;
}

.nav-placeholder {
  width: 60rpx;
}

.content-scroll {
  padding: 24rpx 32rpx;
  padding-top: calc(164rpx + env(safe-area-inset-top));
}

/* è®¢å•çŠ¶æ€æµç¨‹ */
.status-section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
}

.section-header {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: 700;
  color: #333;
}

.status-badge {
  padding: 8rpx 20rpx;
  border-radius: 20rpx;
  font-size: 24rpx;
  font-weight: 600;
}

.badge-1 {
  color: #FF6B00;
  background-color: #FFF3E6;
}

.badge-2 {
  color: #3B82F6;
  background-color: #EFF6FF;
}

.badge-3 {
  color: #10B981;
  background-color: #ECFDF5;
}

.badge-4 {
  color: #8B5CF6;
  background-color: #F5F3FF;
}

.badge-5 {
  color: #F59E0B;
  background-color: #FFFBEB;
}

.badge-6 {
  color: #06B6D4;
  background-color: #ECFEFF;
}

.badge-7 {
  color: #10B981;
  background-color: #ECFDF5;
}

.badge-9 {
  color: #999;
  background-color: #F5F5F5;
}

/* çŠ¶æ€æ—¶é—´è½´ */
.status-timeline {
  position: relative;
}

.timeline-item {
  display: flex;
  flex-direction: row;
  position: relative;
  padding-bottom: 40rpx;
}

.timeline-item:last-child {
  padding-bottom: 0;
}

.timeline-dot {
  width: 48rpx;
  height: 48rpx;
  border-radius: 50%;
  background-color: #E0E0E0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  position: relative;
  z-index: 2;
}

.timeline-item.active .timeline-dot {
  background-color: #E53935;
}

.timeline-item.current .timeline-dot {
  background-color: #E53935;
  box-shadow: 0 0 0 8rpx rgba(229, 57, 53, 0.2);
}

.timeline-item.rejected .timeline-dot {
  background-color: #999;
}

.dot-icon {
  color: #fff;
  font-size: 24rpx;
  font-weight: 700;
}

.timeline-content {
  flex: 1;
  margin-left: 24rpx;
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.timeline-title {
  font-size: 28rpx;
  font-weight: 600;
  color: #666;
}

.timeline-item.active .timeline-title {
  color: #333;
}

.timeline-item.current .timeline-title {
  color: #E53935;
}

.timeline-time {
  font-size: 24rpx;
  color: #999;
}

.timeline-operator {
  font-size: 24rpx;
  color: #999;
}

.timeline-desc {
  font-size: 24rpx;
  color: #999;
}

.timeline-line {
  position: absolute;
  left: 24rpx;
  top: 48rpx;
  bottom: 0;
  width: 2rpx;
  background-color: #E0E0E0;
  z-index: 1;
}

.timeline-item.active .timeline-line {
  background-color: #E53935;
}

/* åå°ç®¡ç†æ“ä½œåŒº */
.admin-actions-section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
  border: 2rpx solid #E53935;
}

.action-card {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
}

.card-title {
  font-size: 28rpx;
  font-weight: 700;
  color: #E53935;
  margin-bottom: 8rpx;
}

/* è¡¨å• */
.form-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 16rpx;
  padding: 20rpx;
  background-color: #F5F5F5;
  border-radius: 12rpx;
}

.form-label {
  font-size: 28rpx;
  color: #666;
  min-width: 140rpx;
}

.form-input {
  flex: 1;
  font-size: 28rpx;
  color: #333;
  background-color: #fff;
  padding: 16rpx;
  border-radius: 8rpx;
  border: 1rpx solid #E0E0E0;
}

.form-unit {
  font-size: 28rpx;
  color: #666;
}

.picker-value {
  flex: 1;
  font-size: 28rpx;
  color: #333;
  padding: 16rpx;
  background-color: #fff;
  border-radius: 8rpx;
  border: 1rpx solid #E0E0E0;
}

/* å·¥ç¨‹å¸ˆæ¥å•æ±  */
.engineer-pool {
  padding: 20rpx;
  background-color: #EFF6FF;
  border-radius: 12rpx;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.pool-tip {
  font-size: 26rpx;
  color: #3B82F6;
}

/* åˆåŒä¿¡æ¯ */
.contract-info {
  padding: 20rpx;
  background-color: #F5F5F5;
  border-radius: 12rpx;
  display: flex;
  flex-direction: column;
  gap: 16rpx;
}

.contract-file {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 16rpx;
  padding: 24rpx;
  background-color: #F5F5F5;
  border-radius: 12rpx;
}

.file-icon {
  font-size: 40rpx;
}

.file-name {
  flex: 1;
  font-size: 28rpx;
  color: #333;
}

.file-action {
  font-size: 26rpx;
  color: #E53935;
}

/* å®¡æ ¸æ“ä½œ */
.audit-actions {
  display: flex;
  flex-direction: row;
  gap: 16rpx;
}

/* é©³å›ä¿¡æ¯ */
.reject-info {
  padding: 20rpx;
  background-color: #FEF2F2;
  border-radius: 12rpx;
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.reject-label {
  font-size: 26rpx;
  color: #999;
}

.reject-reason {
  font-size: 28rpx;
  color: #E53935;
  line-height: 1.6;
}

/* åå°ç®¡ç†æŒ‰é’® */
.admin-btn {
  padding: 24rpx;
  border-radius: 12rpx;
  font-size: 28rpx;
  font-weight: 600;
  border: 1rpx solid #E0E0E0;
  background-color: #fff;
  color: #666;
  line-height: 1;
}

.admin-btn.primary {
  border-color: #E53935;
  background-color: #E53935;
  color: #fff;
}

.admin-btn.secondary {
  border-color: #E0E0E0;
  background-color: #F5F5F5;
  color: #666;
}

.admin-btn.danger {
  border-color: #E53935;
  background-color: #fff;
  color: #E53935;
}

.admin-btn[disabled] {
  opacity: 0.5;
}

/* ä¿¡æ¯å¡ç‰‡ */
.info-section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
}

.info-card {
  display: flex;
  flex-direction: column;
  gap: 24rpx;
}

.info-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
}

.info-row.highlight {
  padding: 20rpx;
  background-color: #FFF3E6;
  border-radius: 12rpx;
}

.info-label {
  font-size: 26rpx;
  color: #999;
  min-width: 140rpx;
}

.info-value {
  flex: 1;
  font-size: 28rpx;
  color: #333;
  text-align: right;
  word-break: break-all;
}

.info-value.multi-line {
  text-align: left;
  margin-left: 20rpx;
}

.info-value.price {
  font-size: 36rpx;
  font-weight: 700;
  color: #E53935;
}

.info-value.link {
  color: #E53935;
}

.info-value.selectable {
  user-select: text;
}

/* å®¢æˆ·/å·¥ç¨‹å¸ˆå¤´éƒ¨ */
.customer-header,
.engineer-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 20rpx;
  padding-bottom: 24rpx;
  border-bottom: 1rpx solid #f0f0f0;
  margin-bottom: 24rpx;
}

.avatar {
  width: 96rpx;
  height: 96rpx;
  border-radius: 50%;
  background-color: #f5f5f5;
}

.customer-info,
.engineer-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.customer-name,
.engineer-name {
  font-size: 32rpx;
  font-weight: 700;
  color: #333;
}

.customer-phone {
  font-size: 26rpx;
  color: #666;
}

.engineer-tags {
  display: flex;
  flex-direction: row;
  gap: 12rpx;
  flex-wrap: wrap;
}

.tag {
  font-size: 22rpx;
  color: #E53935;
  background-color: #FFEBEE;
  padding: 6rpx 16rpx;
  border-radius: 8rpx;
}

.contact-btn {
  padding: 16rpx 32rpx;
  background-color: #E53935;
  color: #fff;
  border: none;
  border-radius: 40rpx;
  font-size: 26rpx;
  line-height: 1;
}

/* æ²Ÿé€šè®°å½• */
.comm-item {
  padding: 20rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
}

.comm-item:last-child {
  border-bottom: none;
}

.comm-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 16rpx;
  margin-bottom: 12rpx;
}

.comm-user {
  font-size: 26rpx;
  font-weight: 600;
  color: #333;
}

.comm-role {
  font-size: 22rpx;
  color: #fff;
  background-color: #E53935;
  padding: 4rpx 12rpx;
  border-radius: 8rpx;
}

.comm-time {
  font-size: 24rpx;
  color: #999;
  margin-left: auto;
}

.comm-content {
  font-size: 26rpx;
  color: #666;
  line-height: 1.6;
}

/* æ“ä½œæ—¥å¿— */
.log-item {
  display: flex;
  flex-direction: row;
  gap: 20rpx;
  padding: 20rpx 0;
  position: relative;
}

.log-item:not(:last-child)::after {
  content: '';
  position: absolute;
  left: 8rpx;
  top: 40rpx;
  bottom: -20rpx;
  width: 2rpx;
  background-color: #E0E0E0;
}

.log-dot {
  width: 16rpx;
  height: 16rpx;
  border-radius: 50%;
  background-color: #E53935;
  margin-top: 8rpx;
  flex-shrink: 0;
}

.log-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.log-text {
  font-size: 28rpx;
  color: #333;
}

.log-time {
  font-size: 24rpx;
  color: #999;
}

.log-operator {
  font-size: 24rpx;
  color: #999;
}
</style>




