<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <text class="nav-back" @click="goBack">â†</text>
      <text class="nav-title">å®åè®¤è¯</text>
      <view class="nav-placeholder"></view>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- è®¤è¯è¯´æ˜å¡ç‰‡ -->
      <view class="info-card">
        <view class="shield-icon">
          <text class="shield-inner">ğŸ›¡ï¸</text>
        </view>
        <text class="card-title">å®åè®¤è¯</text>
        <text class="card-subtitle">ä¿éšœæ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œäº«å—æ›´å¤šæœåŠ¡</text>
      </view>

      <!-- ä¸ºä»€ä¹ˆéœ€è¦å®åè®¤è¯ -->
      <view class="why-section">
        <view class="why-header">
          <text class="why-icon">ğŸ’¡</text>
          <text class="why-title">ä¸ºä»€ä¹ˆéœ€è¦å®åè®¤è¯ï¼Ÿ</text>
        </view>
        <view class="why-list">
          <view class="why-item">
            <text class="dot">â€¢</text>
            <text class="why-text">ä¿éšœæ‚¨çš„è´¦æˆ·å®‰å…¨</text>
          </view>
          <view class="why-item">
            <text class="dot">â€¢</text>
            <text class="why-text">äº«å—æ›´å¤šå¹³å°æœåŠ¡</text>
          </view>
          <view class="why-item">
            <text class="dot">â€¢</text>
            <text class="why-text">ç¬¦åˆå›½å®¶å®ååˆ¶è¦æ±‚</text>
          </view>
          <view class="why-item">
            <text class="dot">â€¢</text>
            <text class="why-text">æå‡è®¢å•æˆäº¤ç‡</text>
          </view>
        </view>
      </view>

      <!-- è¡¨å•åŒºåŸŸ -->
      <view class="form-section">
        <!-- çœŸå®å§“å -->
        <view class="form-item">
          <view class="form-label">
            <text class="label-icon">ğŸ‘¤</text>
            <text class="label-text">çœŸå®å§“å</text>
          </view>
          <input 
            class="form-input" 
            v-model="formData.realName" 
            placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å"
            placeholder-class="input-placeholder"
          />
        </view>

        <!-- èº«ä»½è¯å·ç  -->
        <view class="form-item">
          <view class="form-label">
            <text class="label-icon">ğŸªª</text>
            <text class="label-text">èº«ä»½è¯å·ç </text>
          </view>
          <input 
            class="form-input" 
            v-model="formData.idCard" 
            placeholder="è¯·è¾“å…¥èº«ä»½è¯å·ç "
            placeholder-class="input-placeholder"
            maxlength="18"
          />
        </view>

        <!-- ä¸Šä¼ èº«ä»½è¯ç…§ç‰‡ -->
        <view class="form-item">
          <view class="form-label">
            <text class="label-icon">ğŸ“¤</text>
            <text class="label-text">ä¸Šä¼ èº«ä»½è¯ç…§ç‰‡</text>
          </view>
          <view class="upload-container">
            <view class="upload-box" @click="chooseImage('front')">
              <image v-if="formData.idCardFront" class="upload-image" :src="formData.idCardFront" mode="aspectFill"></image>
              <view v-else class="upload-placeholder">
                <text class="upload-icon">ğŸªª</text>
                <text class="upload-text">èº«ä»½è¯äººåƒé¢</text>
                <text class="upload-hint">ç‚¹å‡»ä¸Šä¼ </text>
              </view>
            </view>
            <view class="upload-box" @click="chooseImage('back')">
              <image v-if="formData.idCardBack" class="upload-image" :src="formData.idCardBack" mode="aspectFill"></image>
              <view v-else class="upload-placeholder">
                <text class="upload-icon">ğŸªª</text>
                <text class="upload-text">èº«ä»½è¯å›½å¾½é¢</text>
                <text class="upload-hint">ç‚¹å‡»ä¸Šä¼ </text>
              </view>
            </view>
          </view>
          <text class="example-link" @click="showExample">ğŸ“· æŸ¥çœ‹ç¤ºä¾‹å›¾ç‰‡</text>
        </view>

        <!-- åŒæ„åè®® -->
        <view class="agreement-section">
          <checkbox-group @change="onAgreementChange">
            <label class="agreement-label">
              <checkbox :checked="agreed" color="#F44336" />
              <text class="agreement-text">
                æˆ‘å·²é˜…è¯»å¹¶åŒæ„ 
                <text class="agreement-link" @click.stop="viewAgreement('verify')">ã€Šå®åè®¤è¯åè®®ã€‹</text>
                å’Œ 
                <text class="agreement-link" @click.stop="viewAgreement('privacy')">ã€Šéšç§æ”¿ç­–ã€‹</text>
                ï¼Œæ‰¿è¯ºæä¾›çš„ä¿¡æ¯çœŸå®æœ‰æ•ˆ
              </text>
            </label>
          </checkbox-group>
        </view>

        <!-- æäº¤æŒ‰é’® -->
        <button class="submit-btn" :class="{ disabled: !canSubmit }" @click="handleSubmit">
          <text class="btn-icon">âœ“</text>
          æäº¤è®¤è¯
        </button>

        <!-- æ¸©é¦¨æç¤º -->
        <view class="tips-section">
          <view class="tips-header">
            <text class="tips-icon">ğŸ’¡</text>
            <text class="tips-title">æ¸©é¦¨æç¤º</text>
          </view>
          <view class="tips-list">
            <text class="tip-item">â€¢ è¯·ç¡®ä¿ç…§ç‰‡æ¸…æ™°å®Œæ•´ï¼Œå››è§’å®Œæ•´å¯è§</text>
            <text class="tip-item">â€¢ ç…§ç‰‡å¤§å°ä¸è¶…è¿‡5MBï¼Œæ”¯æŒJPGã€PNGæ ¼å¼</text>
            <text class="tip-item">â€¢ æ‚¨çš„ä¿¡æ¯å°†è¢«åŠ å¯†ä¿æŠ¤ï¼Œä»…ç”¨äºå®åè®¤è¯</text>
            <text class="tip-item">â€¢ è®¤è¯å®¡æ ¸é€šå¸¸åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆ</text>
          </view>
        </view>
      </view>

      <!-- å ä½ -->
      <view style="height: 80rpx;"></view>
    </scroll-view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'

const formData = ref({
  realName: '',
  idCard: '',
  idCardFront: '',
  idCardBack: ''
})

const agreed = ref(false)

// æ˜¯å¦å¯ä»¥æäº¤
const canSubmit = computed(() => {
  return formData.value.realName && 
         formData.value.idCard && 
         formData.value.idCardFront && 
         formData.value.idCardBack && 
         agreed.value
})

// è¿”å›
function goBack() {
  uni.navigateBack()
}

// é€‰æ‹©å›¾ç‰‡
function chooseImage(type: string) {
  uni.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      const tempFilePaths = res.tempFilePaths
      if (tempFilePaths.length > 0) {
        if (type === 'front') {
          formData.value.idCardFront = tempFilePaths[0]
        } else {
          formData.value.idCardBack = tempFilePaths[0]
        }
      }
    },
    fail: (err) => {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', err)
      uni.showToast({
        title: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥',
        icon: 'none'
      })
    }
  })
}

// æŸ¥çœ‹ç¤ºä¾‹å›¾ç‰‡
function showExample() {
  uni.showModal({
    title: 'ç¤ºä¾‹è¯´æ˜',
    content: 'è¯·ç¡®ä¿èº«ä»½è¯ç…§ç‰‡æ¸…æ™°å®Œæ•´ï¼Œå››è§’å¯è§ï¼Œå…‰çº¿å……è¶³ï¼Œæ— åå…‰é®æŒ¡ã€‚',
    showCancel: false
  })
}

// åŒæ„åè®®æ”¹å˜
function onAgreementChange(e: any) {
  agreed.value = e.detail.value.length > 0
}

// æŸ¥çœ‹åè®®
function viewAgreement(type: string) {
  const title = type === 'verify' ? 'å®åè®¤è¯åè®®' : 'éšç§æ”¿ç­–'
  uni.showModal({
    title: title,
    content: 'åè®®å†…å®¹é¡µé¢å¼€å‘ä¸­...',
    showCancel: false
  })
}

// éªŒè¯èº«ä»½è¯å·
function validateIdCard(idCard: string): boolean {
  const reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/
  return reg.test(idCard)
}

// æäº¤è®¤è¯
function handleSubmit() {
  if (!canSubmit.value) {
    uni.showToast({
      title: 'è¯·å®Œå–„æ‰€æœ‰ä¿¡æ¯',
      icon: 'none'
    })
    return
  }

  // éªŒè¯èº«ä»½è¯å·æ ¼å¼
  if (!validateIdCard(formData.value.idCard)) {
    uni.showToast({
      title: 'èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®',
      icon: 'none'
    })
    return
  }

  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  uni.showModal({
    title: 'ç¡®è®¤æäº¤',
    content: 'è¯·ç¡®è®¤æ‚¨æä¾›çš„ä¿¡æ¯çœŸå®æœ‰æ•ˆï¼Œæäº¤åå°†è¿›å…¥å®¡æ ¸æµç¨‹ã€‚',
    success: (res) => {
      if (res.confirm) {
        submitVerification()
      }
    }
  })
}

// æäº¤å®åè®¤è¯
function submitVerification() {
  uni.showLoading({
    title: 'æäº¤ä¸­...'
  })

  // TODO: å®é™…åº”ä¸Šä¼ å›¾ç‰‡å¹¶è°ƒç”¨åç«¯API
  // 1. ä¸Šä¼ èº«ä»½è¯æ­£é¢ç…§ç‰‡
  // 2. ä¸Šä¼ èº«ä»½è¯åé¢ç…§ç‰‡
  // 3. æäº¤è®¤è¯ä¿¡æ¯
  
  // æ¨¡æ‹Ÿæäº¤
  setTimeout(() => {
    uni.hideLoading()
    
    // TODO: è°ƒç”¨åç«¯API
    // POST /api/user/verify
    // {
    //   real_name: formData.value.realName,
    //   id_card: formData.value.idCard,
    //   id_card_front_url: 'ä¸Šä¼ åçš„å›¾ç‰‡URL',
    //   id_card_back_url: 'ä¸Šä¼ åçš„å›¾ç‰‡URL'
    // }
    
    uni.showModal({
      title: 'æäº¤æˆåŠŸ',
      content: 'æ‚¨çš„å®åè®¤è¯ç”³è¯·å·²æäº¤ï¼Œæˆ‘ä»¬å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚',
      showCancel: false,
      success: () => {
        // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯çš„è®¤è¯çŠ¶æ€
        const userInfo = uni.getStorageSync('userInfo')
        if (userInfo) {
          userInfo.is_verified = true
          userInfo.verify_status = 'pending' // pending: å®¡æ ¸ä¸­, approved: å·²é€šè¿‡, rejected: å·²æ‹’ç»
          uni.setStorageSync('userInfo', userInfo)
        }
        
        // è¿”å›ä¸Šä¸€é¡µ
        uni.navigateBack()
      }
    })
  }, 2000)
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background-color: #F5F5F5;
  display: flex;
  flex-direction: column;
}

.top-nav {
  background: #FFFFFF;
  padding: calc(env(safe-area-inset-top) + 20rpx) 32rpx 20rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1rpx solid #F0F0F0;
}

.nav-back {
  font-size: 44rpx;
  color: #333;
  width: 80rpx;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  flex: 1;
  text-align: center;
}

.nav-placeholder {
  width: 80rpx;
}

.content-scroll {
  flex: 1;
}

// è®¤è¯è¯´æ˜å¡ç‰‡
.info-card {
  background: linear-gradient(135deg, #F44336 0%, #E53935 100%);
  margin: 32rpx;
  padding: 60rpx 32rpx;
  border-radius: 16rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 8rpx 24rpx rgba(244, 67, 54, 0.3);
}

.shield-icon {
  width: 120rpx;
  height: 120rpx;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 32rpx;
}

.shield-inner {
  font-size: 64rpx;
}

.card-title {
  font-size: 40rpx;
  font-weight: 700;
  color: #FFFFFF;
  margin-bottom: 16rpx;
}

.card-subtitle {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.9);
}

// ä¸ºä»€ä¹ˆéœ€è¦å®åè®¤è¯
.why-section {
  background: linear-gradient(135deg, #FFF9E6 0%, #FFE7BA 100%);
  margin: 0 32rpx 32rpx;
  padding: 32rpx;
  border-radius: 16rpx;
  border: 1rpx solid #FFD591;
}

.why-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  margin-bottom: 24rpx;
}

.why-icon {
  font-size: 36rpx;
  margin-right: 12rpx;
}

.why-title {
  font-size: 30rpx;
  font-weight: 600;
  color: #333;
}

.why-list {
  display: flex;
  flex-direction: column;
  gap: 12rpx;
}

.why-item {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
}

.dot {
  font-size: 28rpx;
  color: #F44336;
  margin-right: 12rpx;
  line-height: 1.5;
}

.why-text {
  font-size: 26rpx;
  color: #666;
  line-height: 1.5;
}

// è¡¨å•åŒºåŸŸ
.form-section {
  padding: 0 32rpx;
}

.form-item {
  margin-bottom: 40rpx;
}

.form-label {
  display: flex;
  flex-direction: row;
  align-items: center;
  margin-bottom: 16rpx;
}

.label-icon {
  font-size: 32rpx;
  margin-right: 12rpx;
}

.label-text {
  font-size: 30rpx;
  font-weight: 600;
  color: #333;
}

.form-input {
  background: #FFFFFF;
  padding: 28rpx 32rpx;
  border-radius: 12rpx;
  font-size: 28rpx;
  color: #333;
  border: 1rpx solid #E0E0E0;
}

.input-placeholder {
  color: #BDBDBD;
}

// ä¸Šä¼ åŒºåŸŸ
.upload-container {
  display: flex;
  flex-direction: row;
  gap: 24rpx;
  margin-bottom: 16rpx;
}

.upload-box {
  flex: 1;
  height: 360rpx;
  background: #FFFFFF;
  border: 2rpx dashed #D9D9D9;
  border-radius: 12rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.upload-image {
  width: 100%;
  height: 100%;
}

.upload-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12rpx;
}

.upload-icon {
  font-size: 64rpx;
  opacity: 0.3;
}

.upload-text {
  font-size: 26rpx;
  color: #666;
}

.upload-hint {
  font-size: 24rpx;
  color: #999;
}

.example-link {
  font-size: 24rpx;
  color: #F44336;
  text-decoration: underline;
}

// åŒæ„åè®®
.agreement-section {
  margin-bottom: 32rpx;
}

.agreement-label {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 12rpx;
}

.agreement-text {
  flex: 1;
  font-size: 24rpx;
  color: #666;
  line-height: 1.6;
}

.agreement-link {
  color: #F44336;
}

// æäº¤æŒ‰é’®
.submit-btn {
  width: 100%;
  background: linear-gradient(135deg, #F44336 0%, #E53935 100%);
  color: #FFFFFF;
  padding: 28rpx;
  border-radius: 48rpx;
  font-size: 32rpx;
  font-weight: 600;
  border: none;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 12rpx;
  box-shadow: 0 8rpx 24rpx rgba(244, 67, 54, 0.3);
  margin-bottom: 32rpx;
}

.submit-btn.disabled {
  background: #BDBDBD;
  box-shadow: none;
  opacity: 0.6;
}

.btn-icon {
  font-size: 32rpx;
}

// æ¸©é¦¨æç¤º
.tips-section {
  background: #F0F7FF;
  padding: 24rpx;
  border-radius: 12rpx;
  border: 1rpx solid #BAE7FF;
}

.tips-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  margin-bottom: 16rpx;
}

.tips-icon {
  font-size: 32rpx;
  margin-right: 8rpx;
}

.tips-title {
  font-size: 28rpx;
  font-weight: 600;
  color: #1890FF;
}

.tips-list {
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.tip-item {
  font-size: 24rpx;
  color: #666;
  line-height: 1.6;
}
</style>

