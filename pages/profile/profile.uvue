<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <text class="nav-title">æˆ‘çš„</text>
      <text class="nav-settings" @click="goToSettings">âš™</text>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
      <view class="user-card">
        <view class="user-info-section" @click="goToProfile">
          <view class="user-info-left">
            <view class="user-avatar">
              <image v-if="userInfo.avatar" class="avatar-image" :src="userInfo.avatar" mode="aspectFill"></image>
              <text v-else class="avatar-placeholder">ğŸ‘¤</text>
            </view>
            <view class="user-details">
              <view class="user-name-row">
                <text class="user-name">{{ userInfo.nickname || 'å¾®ä¿¡ç”¨æˆ·' }}</text>
                <view class="vip-badge" v-if="userInfo.vip_level > 0">
                  <text class="vip-icon">ğŸ‘‘</text>
                  <text class="vip-text">VIPä¼šå‘˜</text>
                </view>
              </view>
              <text class="user-id">ID: {{ userInfo.id || 'CU10086' }}</text>
            </view>
          </view>
          <text class="user-arrow">â€º</text>
        </view>
        
        <!-- ç»Ÿè®¡æ•°æ® -->
        <view class="stats-row">
          <view class="stat-item">
            <text class="stat-value">Â¥{{ stats.totalAmount }}</text>
            <text class="stat-label">è´¦æˆ·ä½™é¢</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{ stats.coupons }}</text>
            <text class="stat-label">ä¼˜æƒ åˆ¸</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{ stats.points }}</text>
            <text class="stat-label">ç§¯åˆ†</text>
          </view>
        </view>
      </view>

      <!-- æˆ‘çš„è®¢å• -->
      <view class="section">
        <view class="section-header">
          <text class="section-title">æˆ‘çš„è®¢å•</text>
          <view class="section-more" @click="goToOrders">
            <text class="more-text">æŸ¥çœ‹å…¨éƒ¨</text>
            <text class="more-arrow">â€º</text>
          </view>
        </view>
        <view class="order-status-list">
          <view class="order-status-item" @click="goToOrders('pending')">
            <view class="status-icon-wrapper red">
              <image class="status-icon-image" src="/static/icon-png-profile/æ—¶é—´ é’Ÿè¡¨.png" mode="aspectFit"></image>
              <view class="status-badge" v-if="orderCounts.pending > 0">{{ orderCounts.pending }}</view>
            </view>
            <text class="status-text">å¾…æ¥å•</text>
          </view>
          <view class="order-status-item" @click="goToOrders('inService')">
            <view class="status-icon-wrapper blue">
              <image class="status-icon-image" src="/static/icon-png-profile/ç»´ä¿®å·¥å…·.png" mode="aspectFit"></image>
              <view class="status-badge" v-if="orderCounts.inService > 0">{{ orderCounts.inService }}</view>
            </view>
            <text class="status-text">æœåŠ¡ä¸­</text>
          </view>
          <view class="order-status-item" @click="goToOrders('toCheck')">
            <view class="status-icon-wrapper green">
              <image class="status-icon-image" src="/static/icon-png-profile/å®Œæˆ.png" mode="aspectFit"></image>
            </view>
            <text class="status-text">å¾…éªŒæ”¶</text>
          </view>
          <view class="order-status-item" @click="goToOrders('toRate')">
            <view class="status-icon-wrapper yellow">
              <image class="status-icon-image" src="/static/icons/è¯„ä»·.png" mode="aspectFit"></image>
            </view>
            <text class="status-text">å¾…è¯„ä»·</text>
          </view>
        </view>
      </view>

      <!-- å¸¸ç”¨åŠŸèƒ½ -->
      <view class="section">
        <text class="section-title">å¸¸ç”¨åŠŸèƒ½</text>
        <view class="menu-list">
          <view class="menu-item" @click="handleMenuClick('address')">
            <view class="menu-icon red">
              <image class="menu-icon-image" src="/static/icon-png-profile/åœ°å€.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">åœ°å€ç®¡ç†</text>
            <text class="menu-arrow">â€º</text>
          </view>
          <view class="menu-item" @click="handleMenuClick('favorite')">
            <view class="menu-icon yellow">
              <image class="menu-icon-image" src="/static/icon-png-profile/æ”¶è—.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">æˆ‘çš„æ”¶è—</text>
            <text class="menu-arrow">â€º</text>
          </view>
          <view class="menu-item" @click="handleMenuClick('wallet')">
            <view class="menu-icon green">
              <image class="menu-icon-image" src="/static/icon-png-profile/ç†è´¢.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">æˆ‘çš„é’±åŒ…</text>
            <text class="menu-arrow">â€º</text>
          </view>
          <view class="menu-item" @click="handleMenuClick('coupon')">
            <view class="menu-icon pink">
              <image class="menu-icon-image" src="/static/icon-png-profile/ä¼˜æƒ åˆ¸.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">ä¼˜æƒ åˆ¸</text>
            <view class="coupon-badge" v-if="stats.coupons > 0">{{ stats.coupons }}å¼ </view>
            <text class="menu-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- å…¶ä»–æœåŠ¡ -->
      <view class="section">
        <text class="section-title">å…¶ä»–æœåŠ¡</text>
        <view class="menu-list">
          <view class="menu-item" @click="handleMenuClick('service')">
            <view class="menu-icon gray">
              <image class="menu-icon-image" src="/static/icon-png-profile/å®¢æœ (1).png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">è”ç³»å®¢æœ</text>
            <text class="menu-arrow">â€º</text>
          </view>
          <view class="menu-item" @click="handleMenuClick('agreement')">
            <view class="menu-icon gray">
              <image class="menu-icon-image" src="/static/icon-png-profile/å°±ä¸šåè®®.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">æœåŠ¡åè®®</text>
            <text class="menu-arrow">â€º</text>
          </view>
          <view class="menu-item" @click="handleMenuClick('privacy')">
            <view class="menu-icon gray">
              <image class="menu-icon-image" src="/static/icon-png-profile/æœåŠ¡æ¡æ¬¾åŠéšç§.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">éšç§æ”¿ç­–</text>
            <text class="menu-arrow">â€º</text>
          </view>
          <view class="menu-item" @click="handleMenuClick('about')">
            <view class="menu-icon gray">
              <image class="menu-icon-image" src="/static/icon-png-profile/å…³äº.png" mode="aspectFit"></image>
            </view>
            <text class="menu-text">å…³äºæˆ‘ä»¬</text>
            <text class="menu-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- å¼€å‘å·¥å…·å…¥å£ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ -->
      <view class="section" v-if="showDevTools">
        <view class="section-title">
          <text class="title-icon">ğŸ› </text>
          <text class="title-text">å¼€å‘å·¥å…·</text>
        </view>
        <view class="menu-list">
          <view class="menu-item dev-item" @click="goToMockLoginDemo">
            <view class="menu-icon purple">
              <text class="menu-icon-emoji">ğŸ‘¤</text>
            </view>
            <text class="menu-text">æ¨¡æ‹Ÿç™»å½•æµ‹è¯•</text>
            <text class="menu-badge">DEV</text>
            <text class="menu-arrow">â€º</text>
          </view>
        </view>
      </view>

      <!-- å ä½ -->
      <view style="height: 180rpx;"></view>
    </scroll-view>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <view class="bottom-nav">
      <view class="nav-item" @click="navigateTo('home')">
        <image class="nav-icon" src="/static/icons/home.png" mode="aspectFit"></image>
        <text class="nav-label">é¦–é¡µ</text>
      </view>
      <view class="nav-item" @click="navigateTo('order')">
        <image class="nav-icon" src="/static/icons/order.png" mode="aspectFit"></image>
        <text class="nav-label">è®¢å•</text>
        <view class="nav-badge" v-if="orderCounts.total > 0">{{ orderCounts.total }}</view>
      </view>
      <view class="fab-button" @click="handleFabClick">
        <text class="fab-icon">+</text>
      </view>
      <view class="nav-item" @click="navigateTo('message')">
        <image class="nav-icon" src="/static/icons/message.png" mode="aspectFit"></image>
        <text class="nav-label">æ¶ˆæ¯</text>
      </view>
      <view class="nav-item active" @click="navigateTo('profile')">
        <image class="nav-icon" src="/static/icons/profile-active.png" mode="aspectFit"></image>
        <text class="nav-label">æˆ‘çš„</text>
      </view>
    </view>
    
    <!-- æ¨¡æ‹Ÿç”¨æˆ·åˆ‡æ¢ -->
    <MockUserSwitch />
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import MockUserSwitch from '../../components/MockUserSwitch/MockUserSwitch.uvue'
import { isMockLogin } from '../../utils/mock-login'

const userInfo = ref({
  id: 'CU10086',
  nickname: 'å¼ å…ˆç”Ÿ',
  avatar: '',
  vip_level: 1
})

const stats = ref({
  totalAmount: '1,280',
  coupons: 5,
  points: '2,680'
})

// æ˜¯å¦æ˜¾ç¤ºå¼€å‘å·¥å…·ï¼ˆä»…æ¨¡æ‹Ÿç™»å½•æ—¶æ˜¾ç¤ºï¼‰
const showDevTools = ref(false)

const orderCounts = ref({
  pending: 3,
  inService: 1,
  toCheck: 0,
  toRate: 0,
  total: 4
})

onMounted(() => {
  loadUserInfo()
  loadStats()
  loadOrderCounts()
  // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå¼€å‘å·¥å…·
  showDevTools.value = isMockLogin()
})

function loadUserInfo() {
  const info = uni.getStorageSync('userInfo')
  if (info) {
    userInfo.value = {
      ...userInfo.value,
      ...info
    }
  }
}

function loadStats() {
  // TODO: ä»åç«¯APIè·å–
  // GET /api/user/stats
}

function loadOrderCounts() {
  // TODO: ä»åç«¯APIè·å–
  // GET /api/orders/count
}

function goToSettings() {
  uni.navigateTo({
    url: '/pages/profile/settings'
  })
}

function goToProfile() {
  uni.showToast({
    title: 'ä¸ªäººä¿¡æ¯é¡µé¢å¼€å‘ä¸­',
    icon: 'none'
  })
}

function goToOrders(status?: string) {
  if (status) {
    uni.reLaunch({
      url: `/pages/order/order?status=${status}`
    })
  } else {
    uni.reLaunch({
      url: '/pages/order/order'
    })
  }
}

// è·³è½¬åˆ°æ¨¡æ‹Ÿç™»å½•æµ‹è¯•é¡µé¢
function goToMockLoginDemo() {
  uni.navigateTo({
    url: '/pages/test/mock-login-demo'
  })
}

function handleMenuClick(type: string) {
  const routes: any = {
    'address': '/pages/profile/address',
    'favorite': '/pages/profile/favorite',
    'wallet': '/pages/profile/wallet',
    'coupon': '/pages/profile/coupon',
    'service': '/pages/chat/service',
    'agreement': '/pages/profile/agreement',
    'privacy': '/pages/profile/privacy',
    'about': '/pages/profile/about'
  }

  if (routes[type]) {
    uni.navigateTo({
      url: routes[type]
    })
  } else {
    uni.showToast({
      title: 'åŠŸèƒ½å¼€å‘ä¸­',
      icon: 'none'
    })
  }
}

function handleFabClick() {
  uni.navigateTo({
    url: '/pages/order/create'
  })
}

function navigateTo(page: string) {
  if (page === 'profile') {
    return
  }
  
  const pageMap: any = {
    'home': '/pages/home/home',
    'order': '/pages/order/order',
    'message': '/pages/message/message'
  }
  
  if (pageMap[page]) {
    uni.reLaunch({
      url: pageMap[page]
    })
  }
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background-color: #F5F5F5;
  display: flex;
  flex-direction: column;
  overflow: visible;  /* å…è®¸å­å…ƒç´ æº¢å‡º */
}

.top-nav {
  background-color: #fff;
  padding: 32rpx 32rpx;
  padding-top: calc(64rpx + env(safe-area-inset-top));
  padding-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1rpx solid #f0f0f0;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #000;
}

.nav-settings {
  font-size: 44rpx;
  color: #666;
}

.content-scroll {
  flex: 1;
  padding: 24rpx;
  padding-top: calc(164rpx + env(safe-area-inset-top));
  overflow-x: visible;  /* å…è®¸æ¨ªå‘æº¢å‡ºï¼ˆå¦‚å¾½ç« ï¼‰ */
}

// ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
.user-card {
  background: linear-gradient(135deg, #FF9966 0%, #FF6B45 100%);
  border-radius: 20rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
  box-shadow: 0 8rpx 24rpx rgba(255, 107, 69, 0.3);
}

.user-info-section {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32rpx;
}

.user-info-left {
  display: flex;
  flex-direction: row;
  align-items: center;
  flex: 1;
}

.user-avatar {
  width: 120rpx;
  height: 120rpx;
  border-radius: 60rpx;
  background-color: rgba(255, 255, 255, 0.3);
  margin-right: 24rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.avatar-image {
  width: 100%;
  height: 100%;
}

.avatar-placeholder {
  font-size: 60rpx;
  color: rgba(255, 255, 255, 0.8);
}

.user-details {
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.user-name-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 12rpx;
}

.user-name {
  font-size: 36rpx;
  font-weight: 700;
  color: #fff;
}

.vip-badge {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
  padding: 4rpx 12rpx;
  border-radius: 20rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 4rpx;
}

.vip-icon {
  font-size: 20rpx;
}

.vip-text {
  font-size: 20rpx;
  color: #333;
  font-weight: 600;
}

.user-id {
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.9);
}

.user-arrow {
  font-size: 48rpx;
  color: rgba(255, 255, 255, 0.8);
}

// ç»Ÿè®¡æ•°æ®è¡Œ
.stats-row {
  display: flex;
  flex-direction: row;
  gap: 20rpx;
}

.stat-item {
  flex: 1;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 16rpx;
  padding: 28rpx 20rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8rpx;
}

.stat-value {
  font-size: 36rpx;
  font-weight: 700;
  color: #fff;
}

.stat-label {
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.9);
}

// åŒºå—
.section {
  margin-bottom: 24rpx;
  overflow: visible;  /* å…è®¸å­å…ƒç´ ï¼ˆå¦‚å¾½ç« ï¼‰æº¢å‡ºæ˜¾ç¤º */
}

.section-header {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #000;
}

.section-more {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 4rpx;
}

.more-text {
  font-size: 26rpx;
  color: #F44336;
}

.more-arrow {
  font-size: 32rpx;
  color: #F44336;
}

// è®¢å•çŠ¶æ€åˆ—è¡¨
.order-status-list {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 48rpx 40rpx 32rpx 40rpx;  /* å¢åŠ é¡¶éƒ¨å’Œå·¦å³paddingä¸ºå¾½ç« é¢„ç•™ç©ºé—´ */
  display: flex;
  flex-direction: row;
  justify-content: space-around;
  overflow: visible;  /* å…è®¸å¾½ç« æº¢å‡ºæ˜¾ç¤º */
}

.order-status-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12rpx;
  overflow: visible;  /* å…è®¸å¾½ç« æº¢å‡ºæ˜¾ç¤º */
}

.status-icon-wrapper {
  width: 96rpx;
  height: 96rpx;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: visible;  /* å…è®¸å¾½ç« æº¢å‡º */
  
  &.red {
    background-color: #FFEBEE;
  }
  
  &.blue {
    background-color: #FFEBEE;
  }
  
  &.green {
    background-color: #FFEBEE;
  }
  
  &.yellow {
    background-color: #FFEBEE;
  }
}

.status-icon {
  font-size: 48rpx;
}

.status-icon-image {
  width: 48rpx;
  height: 48rpx;
}

.status-badge {
  position: absolute;
  top: -2rpx;     /* è´´è¿‘é¡¶éƒ¨è¾¹ç¼˜ */
  right: -2rpx;   /* å‘å·¦åç§»ä¸€ç‚¹ç‚¹ */
  min-width: 36rpx;
  height: 36rpx;
  background-color: #F44336;
  border-radius: 18rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 8rpx;
  font-size: 20rpx;
  color: #fff;
  font-weight: 700;
  line-height: 1;
  box-shadow: 0 2rpx 8rpx rgba(244, 67, 54, 0.3);
  z-index: 100;
}

.status-text {
  font-size: 26rpx;
  color: #666;
}

// èœå•åˆ—è¡¨
.menu-list {
  background-color: #fff;
  border-radius: 16rpx;
  overflow: hidden;
}

.menu-item {
  padding: 32rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  border-bottom: 1rpx solid #F0F0F0;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-icon {
  width: 72rpx;
  height: 72rpx;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36rpx;
  margin-right: 24rpx;
  
  &.red {
    background-color: #FFEBEE;
  }
  
  &.yellow {
    background-color: #FFEBEE;
  }
  
  &.green {
    background-color: #FFEBEE;
  }
  
  &.pink {
    background-color: #FFEBEE;
  }
  
  &.blue {
    background-color: #FFEBEE;
  }
  
  &.gray {
    background-color: #FFEBEE;
  }
}

.menu-icon-image {
  width: 40rpx;
  height: 40rpx;
}

.menu-text {
  flex: 1;
  font-size: 30rpx;
  color: #333;
}

.coupon-badge {
  background-color: #F44336;
  color: #fff;
  font-size: 22rpx;
  padding: 4rpx 12rpx;
  border-radius: 20rpx;
  margin-right: 12rpx;
}

.menu-arrow {
  font-size: 44rpx;
  color: #D9D9D9;
}

/* å¼€å‘å·¥å…·æ ·å¼ */
.dev-item {
  background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
  border-left: 4rpx solid #667eea;
}

.menu-icon.purple {
  background-color: #EDE7F6;
}

.menu-icon-emoji {
  font-size: 36rpx;
}

.menu-badge {
  padding: 4rpx 12rpx;
  border-radius: 8rpx;
  font-size: 20rpx;
  color: #fff;
  background-color: #667eea;
  margin-left: 12rpx;
  font-weight: 600;
}

// åº•éƒ¨å¯¼èˆªæ 
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  border-top: 1rpx solid #E5E5E5;
  display: flex;
  flex-direction: row;
  justify-content: space-around;
  align-items: flex-start;
  padding: 8rpx 0 0;
  padding-bottom: calc(56rpx + env(safe-area-inset-bottom));
  height: 56rpx;
  z-index: 999;
  box-shadow: 0 -2rpx 8rpx rgba(0, 0, 0, 0.06);
  overflow: visible;  /* å…è®¸åœ†å½¢æŒ‰é’®æº¢å‡ºåˆ°å¯¼èˆªæ å¤– */
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4rpx;
  flex: 1;
  position: relative;
  margin-top: 0;
}

.nav-item.active {
  color: #F44336;
}

.nav-item.active .nav-label {
  color: #F44336;
}

.nav-icon {
  width: 44rpx;
  height: 44rpx;
}

.nav-item.active .nav-icon {
  opacity: 1;
}

.nav-item:not(.active) .nav-icon {
  opacity: 0.5;
}

.nav-label {
  font-size: 22rpx;
  color: #666;
}

.nav-badge {
  position: absolute;
  top: -4rpx;
  right: 20rpx;
  min-width: 32rpx;
  height: 32rpx;
  background-color: #F44336;
  border-radius: 16rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 8rpx;
  font-size: 20rpx;
  color: #fff;
  font-weight: 600;
}

.fab-button {
  width: 112rpx;
  height: 112rpx;
  background: linear-gradient(135deg, #F44336 0%, #E53935 100%);
  border-radius: 50%;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8rpx 24rpx rgba(244, 67, 54, 0.4);
  margin-top: -56rpx;
  position: relative;
  z-index: 1000;
}

.fab-icon {
  font-size: 56rpx;
  color: #fff;
  font-weight: 700;
  line-height: 1;
  transform: translateY(-4rpx);
}
</style>
