<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <view class="back-btn" @click="goBack">
        <text class="back-icon">â†</text>
      </view>
      <text class="nav-title">æ–°è®¢å•</text>
      <view class="placeholder"></view>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- å€’è®¡æ—¶å¡ç‰‡ -->
      <view class="countdown-card">
        <view class="countdown-wrapper">
          <text class="countdown-number">{{ countdown }}</text>
          <text class="countdown-label">ç§’åè‡ªåŠ¨é‡Šæ”¾è®¢å•</text>
        </view>
        <text class="order-no">è®¢å•ç¼–å·ï¼š{{ orderDetail.orderNo }}</text>
      </view>

      <!-- æœåŠ¡æ ‡é¢˜å’Œä»·æ ¼ -->
      <view class="service-header">
        <text class="service-title">{{ orderDetail.title }}</text>
        <view class="price-wrapper">
          <text class="price-symbol">Â¥</text>
          <text class="price-value">{{ orderDetail.price }}</text>
          <text class="price-label">/ {{ orderDetail.priceType }}</text>
        </view>
      </view>

      <!-- å®¢æˆ·ä¿¡æ¯ -->
      <view class="section">
        <view class="section-header">
          <text class="section-icon">ğŸ‘¤</text>
          <text class="section-title">å®¢æˆ·ä¿¡æ¯</text>
        </view>
        <view class="info-row">
          <image class="avatar" :src="orderDetail.clientAvatar" mode="aspectFill"></image>
          <view class="client-info">
            <text class="client-name">{{ orderDetail.clientName }}</text>
            <text class="client-phone">{{ orderDetail.clientPhone }}</text>
          </view>
          <view class="call-btn" @click="callClient">
            <text class="call-emoji">ğŸ“</text>
          </view>
        </view>
      </view>

      <!-- æœåŠ¡åœ°å€ -->
      <view class="section">
        <view class="section-header">
          <text class="section-icon">ğŸ“</text>
          <text class="section-title">æœåŠ¡åœ°å€</text>
        </view>
        <view class="address-row" @click="navigateToLocation">
          <view class="address-info">
            <text class="address-text">{{ orderDetail.address }}</text>
            <view class="distance-tag">
              <text class="distance-text">è·æ‚¨ {{ orderDetail.distance }}km</text>
            </view>
          </view>
          <text class="arrow-icon">â€º</text>
        </view>
      </view>

      <!-- æœåŠ¡è¯¦æƒ… -->
      <view class="section">
        <view class="section-header">
          <text class="section-icon">ğŸ“‹</text>
          <text class="section-title">æœåŠ¡è¯¦æƒ…</text>
        </view>

        <view class="detail-item">
          <text class="detail-label">æœåŠ¡ç±»å‹</text>
          <text class="detail-value">{{ orderDetail.serviceTypeText }}</text>
        </view>

        <view class="detail-item">
          <text class="detail-label">ä¸šåŠ¡é¢†åŸŸ</text>
          <text class="detail-value">{{ orderDetail.domainName }}</text>
        </view>

        <view class="detail-item">
          <text class="detail-label">è®¾å¤‡å‹å·</text>
          <text class="detail-value">{{ orderDetail.deviceModel }}</text>
        </view>

        <view class="detail-item">
          <text class="detail-label">æ•…éšœæè¿°</text>
          <text class="detail-value multiline">{{ orderDetail.description }}</text>
        </view>

        <view class="detail-item">
          <text class="detail-label">é¢„çº¦æ—¶é—´</text>
          <text class="detail-value">{{ orderDetail.serviceTime }}</text>
        </view>

        <view class="detail-item">
          <text class="detail-label">é¢„ä¼°å·¥æœŸ</text>
          <text class="detail-value">{{ orderDetail.estimatedDays }}</text>
        </view>

        <view class="detail-item" v-if="orderDetail.requirements">
          <text class="detail-label">ç‰¹æ®Šè¦æ±‚</text>
          <text class="detail-value">{{ orderDetail.requirements }}</text>
        </view>

        <!-- ç°åœºæ‹ç…§å’Œç»´ä¿®æ–¹æ¡ˆæŒ‰é’® -->
        <view class="attachment-btns" v-if="orderDetail.hasAttachments">
          <view class="attachment-btn" @click="viewPhotos" v-if="orderDetail.images && orderDetail.images.length > 0">
            <text class="attachment-icon">ğŸ“·</text>
            <text class="attachment-text">ç°åœºæ‹ç…§</text>
          </view>
          <view class="attachment-btn" @click="viewPlan" v-if="orderDetail.hasPlan">
            <text class="attachment-icon">ğŸ“„</text>
            <text class="attachment-text">ç»´ä¿®æ–¹æ¡ˆ</text>
          </view>
        </view>
      </view>

      <!-- æ¸©é¦¨æç¤º -->
      <view class="tips-card">
        <view class="tips-header">
          <text class="tips-icon">â„¹ï¸</text>
          <text class="tips-title">æ¸©é¦¨æç¤ºï¼š</text>
        </view>
        <text class="tips-text">æ¥å•åè¯·åœ¨30åˆ†é’Ÿå†…è”ç³»å®¢æˆ·ç¡®è®¤æœåŠ¡æ—¶é—´ï¼Œå¹¶åœ¨çº¦å®šæ—¶é—´åˆ°è¾¾ç°åœºã€‚å¦‚æ— æ³•æŒ‰æ—¶åˆ°è¾¾ï¼Œè¯·æå‰ä¸å®¢æˆ·æ²Ÿé€šã€‚</text>
      </view>

      <!-- åº•éƒ¨å ä½ -->
      <view style="height: 180rpx;"></view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-actions">
      <button class="action-btn reject-btn" @click="handleReject">
        <text>æ‹’ç»</text>
      </button>
      <button class="action-btn accept-btn" @click="handleAccept">
        <text>ç«‹å³æ¥å•</text>
      </button>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'

// è·å–è·¯ç”±å‚æ•°
const orderId = ref('')

// å€’è®¡æ—¶
const countdown = ref(0)
let countdownTimer: number | null = null

// è®¢å•è¯¦æƒ…æ•°æ®
const orderDetail = ref({
  id: '',
  orderNo: 'OR202511180001',
  title: 'å……ç”µæ¡©ç»´ä¿®æœåŠ¡',
  price: '1,200',
  priceType: 'é¢„ä¼°æ”¶ç›Š',
  serviceTypeText: 'å”®åç»´ä¿®',
  domainName: 'åœºç«™å……ç”µæ¡©',
  address: 'æ±Ÿè‹çœæ‰¬å·å¸‚é‚—æ±ŸåŒºæ–‡æ˜Œè¥¿è·¯456å·æ‰¬å·ç§‘æŠ€æ ¡å›­Aæ ‹',
  distance: 2.8,
  clientName: 'æå…ˆç”Ÿ',
  clientPhone: '138****8888',
  clientAvatar: '/static/icons/profile.png',
  deviceModel: 'XXå“ç‰Œ 120kWç›´æµå……ç”µæ¡©',
  description: 'å……ç”µæ¡©æ— æ³•å¯åŠ¨ï¼Œå±å¹•æ— æ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯ä¸»æ§æ¿æ•…éšœ',
  serviceTime: '2025-11-18 14:00 - 18:00',
  estimatedDays: '2å¤©',
  requirements: 'éœ€è¦ç°åœºæ‹ç…§è®°å½•ã€æä¾›ç»´ä¿®æ–¹æ¡ˆ',
  images: [],
  hasAttachments: true,
  hasPlan: true,
  latitude: 32.3944,
  longitude: 119.4201
})

onMounted(() => {
  // è·å–è·¯ç”±å‚æ•°
  const pages = getCurrentPages()
  const currentPage = pages[pages.length - 1] as any
  orderId.value = currentPage.$route?.query?.id || ''
  
  // åŠ è½½è®¢å•è¯¦æƒ…
  loadOrderDetail()
  
  // å¼€å§‹å€’è®¡æ—¶
  startCountdown()
})

onUnmounted(() => {
  // æ¸…é™¤å€’è®¡æ—¶
  if (countdownTimer) {
    clearInterval(countdownTimer)
  }
})

// åŠ è½½è®¢å•è¯¦æƒ…
async function loadOrderDetail() {
  try {
    // TODO: è°ƒç”¨APIè·å–è®¢å•è¯¦æƒ…
    // const result = await get(`/api/orders/${orderId.value}`)
    // orderDetail.value = result.data
    console.log('åŠ è½½è®¢å•è¯¦æƒ…:', orderId.value)
    
    // æ¨¡æ‹Ÿæ•°æ®å·²åœ¨ä¸Šé¢å®šä¹‰
  } catch (error) {
    console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error)
    uni.showToast({
      title: 'åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥',
      icon: 'none'
    })
  }
}

// å¼€å§‹å€’è®¡æ—¶
function startCountdown() {
  // åˆå§‹å€’è®¡æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  countdown.value = 30
  
  countdownTimer = setInterval(() => {
    if (countdown.value > 0) {
      countdown.value--
    } else {
      // å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨è¿”å›
      if (countdownTimer) {
        clearInterval(countdownTimer)
      }
      uni.showToast({
        title: 'è®¢å•å·²é‡Šæ”¾',
        icon: 'none',
        duration: 2000
      })
      setTimeout(() => {
        goBack()
      }, 2000)
    }
  }, 1000) as unknown as number
}

// è¿”å›
function goBack() {
  uni.navigateBack({
    fail: () => {
      uni.reLaunch({
        url: '/pages/engineer/home'
      })
    }
  })
}

// æ‹¨æ‰“å®¢æˆ·ç”µè¯
function callClient() {
  uni.showModal({
    title: 'æ‹¨æ‰“ç”µè¯',
    content: `ç¡®è®¤æ‹¨æ‰“ ${orderDetail.value.clientPhone}?`,
    success: (res) => {
      if (res.confirm) {
        const phone = orderDetail.value.clientPhone.replace(/\*/g, '8')
        uni.makePhoneCall({
          phoneNumber: phone,
          fail: () => {
            uni.showToast({
              title: 'æ‹¨å·å¤±è´¥',
              icon: 'none'
            })
          }
        })
      }
    }
  })
}

// å¯¼èˆªåˆ°åœ°å€
function navigateToLocation() {
  uni.openLocation({
    latitude: orderDetail.value.latitude,
    longitude: orderDetail.value.longitude,
    name: 'æœåŠ¡åœ°å€',
    address: orderDetail.value.address,
    scale: 15,
    fail: () => {
      uni.showToast({
        title: 'æ‰“å¼€åœ°å›¾å¤±è´¥',
        icon: 'none'
      })
    }
  })
}

// æŸ¥çœ‹ç°åœºç…§ç‰‡
function viewPhotos() {
  if (orderDetail.value.images && orderDetail.value.images.length > 0) {
    uni.previewImage({
      urls: orderDetail.value.images,
      current: 0
    })
  } else {
    uni.showToast({
      title: 'æš‚æ— ç°åœºç…§ç‰‡',
      icon: 'none'
    })
  }
}

// æŸ¥çœ‹ç»´ä¿®æ–¹æ¡ˆ
function viewPlan() {
  uni.showToast({
    title: 'ç»´ä¿®æ–¹æ¡ˆåŠŸèƒ½å¼€å‘ä¸­',
    icon: 'none'
  })
}

// æ‹’ç»è®¢å•
function handleReject() {
  uni.showModal({
    title: 'æ‹’ç»æ¥å•',
    content: 'ç¡®è®¤è¦æ‹’ç»è¿™ä¸ªè®¢å•å—ï¼Ÿ',
    confirmText: 'ç¡®è®¤æ‹’ç»',
    cancelText: 'å†æƒ³æƒ³',
    success: (res) => {
      if (res.confirm) {
        // æ¸…é™¤å€’è®¡æ—¶
        if (countdownTimer) {
          clearInterval(countdownTimer)
        }
        
        // TODO: è°ƒç”¨APIæ‹’ç»è®¢å•
        uni.showToast({
          title: 'å·²æ‹’ç»è®¢å•',
          icon: 'success',
          duration: 1500
        })
        
        setTimeout(() => {
          goBack()
        }, 1500)
      }
    }
  })
}

// ç«‹å³æ¥å•
function handleAccept() {
  uni.showModal({
    title: 'ç¡®è®¤æ¥å•',
    content: 'è¯·ç¡®è®¤æ‚¨å·²äº†è§£è®¢å•è¯¦æƒ…ï¼Œå¯ä»¥æŒ‰æ—¶å®ŒæˆæœåŠ¡',
    confirmText: 'ç¡®è®¤æ¥å•',
    cancelText: 'å–æ¶ˆ',
    success: async (res) => {
      if (res.confirm) {
        // æ¸…é™¤å€’è®¡æ—¶
        if (countdownTimer) {
          clearInterval(countdownTimer)
        }
        
        try {
          // TODO: è°ƒç”¨æ¥å•API
          // const result = await post(`/api/orders/${orderId.value}/accept`)
          
          uni.showToast({
            title: 'æ¥å•æˆåŠŸ',
            icon: 'success',
            duration: 2000
          })
          
          setTimeout(() => {
            // è·³è½¬åˆ°æˆ‘çš„å·¥å•é¡µé¢
            uni.reLaunch({
              url: '/pages/engineer/workorders'
            })
          }, 2000)
        } catch (error) {
          console.error('æ¥å•å¤±è´¥:', error)
          uni.showToast({
            title: 'æ¥å•å¤±è´¥ï¼Œè¯·é‡è¯•',
            icon: 'none'
          })
        }
      }
    }
  })
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background-color: #f5f5f5;
  display: flex;
  flex-direction: column;
}

// é¡¶éƒ¨å¯¼èˆª
.top-nav {
  background-color: #fff;
  padding: 32rpx 32rpx;
  padding-top: calc(112rpx + env(safe-area-inset-top));
  padding-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1rpx solid #f0f0f0;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
}

.back-btn,
.placeholder {
  width: 44rpx;
  height: 44rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.back-icon {
  font-size: 36rpx;
  color: #333;
  font-weight: 500;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  flex: 1;
  text-align: center;
}

.content-scroll {
  flex: 1;
  padding: 24rpx 32rpx 140rpx;
  padding-top: calc(192rpx + env(safe-area-inset-top));
}

// å€’è®¡æ—¶å¡ç‰‡
.countdown-card {
  background: linear-gradient(135deg, #FF6B35 0%, #E53935 100%);
  border-radius: 24rpx;
  padding: 40rpx;
  margin-bottom: 24rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16rpx;
  box-shadow: 0 8rpx 24rpx rgba(229, 57, 53, 0.3);
}

.countdown-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8rpx;
}

.countdown-number {
  font-size: 96rpx;
  font-weight: 700;
  color: #fff;
  line-height: 1;
}

.countdown-label {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.95);
  font-weight: 500;
}

.order-no {
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.9);
}

// æœåŠ¡æ ‡é¢˜å’Œä»·æ ¼
.service-header {
  background-color: #fff;
  border-radius: 24rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
}

.service-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  display: block;
  margin-bottom: 24rpx;
}

.price-wrapper {
  display: flex;
  flex-direction: row;
  align-items: baseline;
  gap: 4rpx;
}

.price-symbol {
  font-size: 32rpx;
  color: #E53935;
  font-weight: 600;
}

.price-value {
  font-size: 48rpx;
  color: #E53935;
  font-weight: 700;
}

.price-label {
  font-size: 26rpx;
  color: #999;
  margin-left: 8rpx;
}

// é€šç”¨section
.section {
  background-color: #fff;
  border-radius: 24rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
}

.section-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 12rpx;
  margin-bottom: 24rpx;
}

.section-icon {
  font-size: 32rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
}

// å®¢æˆ·ä¿¡æ¯
.info-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 20rpx;
}

.avatar {
  width: 88rpx;
  height: 88rpx;
  border-radius: 50%;
  flex-shrink: 0;
}

.client-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8rpx;
}

.client-name {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
}

.client-phone {
  font-size: 28rpx;
  color: #666;
}

.call-btn {
  width: 80rpx;
  height: 80rpx;
  background-color: #E8F5E9;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.call-emoji {
  font-size: 40rpx;
}

// æœåŠ¡åœ°å€
.address-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 16rpx;
}

.address-info {
  flex: 1;
}

.address-text {
  font-size: 28rpx;
  color: #333;
  line-height: 1.6;
  display: block;
  margin-bottom: 12rpx;
}

.distance-tag {
  display: inline-flex;
  padding: 4rpx 16rpx;
  background-color: #FFF3E0;
  border-radius: 8rpx;
}

.distance-text {
  font-size: 24rpx;
  color: #FF9800;
  font-weight: 500;
}

.arrow-icon {
  font-size: 40rpx;
  color: #999;
  flex-shrink: 0;
}

// æœåŠ¡è¯¦æƒ…
.detail-item {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  padding: 20rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
}

.detail-item:last-of-type {
  border-bottom: none;
}

.detail-label {
  font-size: 28rpx;
  color: #999;
  flex-shrink: 0;
  margin-right: 32rpx;
  width: 160rpx;
}

.detail-value {
  font-size: 28rpx;
  color: #333;
  flex: 1;
  text-align: right;
}

.detail-value.multiline {
  text-align: left;
  line-height: 1.6;
}

// é™„ä»¶æŒ‰é’®
.attachment-btns {
  display: flex;
  flex-direction: row;
  gap: 20rpx;
  margin-top: 24rpx;
  padding-top: 24rpx;
  border-top: 1rpx solid #f0f0f0;
}

.attachment-btn {
  flex: 1;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 12rpx;
  padding: 16rpx;
  background-color: #f8f8f8;
  border-radius: 12rpx;
}

.attachment-icon {
  font-size: 32rpx;
}

.attachment-text {
  font-size: 26rpx;
  color: #666;
  font-weight: 500;
}

// æ¸©é¦¨æç¤º
.tips-card {
  background-color: #E3F2FD;
  border-radius: 16rpx;
  padding: 24rpx;
  margin-bottom: 24rpx;
}

.tips-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8rpx;
  margin-bottom: 12rpx;
}

.tips-icon {
  font-size: 28rpx;
}

.tips-title {
  font-size: 28rpx;
  font-weight: 600;
  color: #1976D2;
}

.tips-text {
  font-size: 26rpx;
  color: #1976D2;
  line-height: 1.6;
  display: block;
}

// åº•éƒ¨æ“ä½œæ 
.bottom-actions {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  padding: 20rpx 32rpx;
  padding-bottom: calc(20rpx + env(safe-area-inset-bottom));
  border-top: 1rpx solid #f0f0f0;
  display: flex;
  flex-direction: row;
  gap: 20rpx;
  box-shadow: 0 -2rpx 12rpx rgba(0, 0, 0, 0.06);
  z-index: 999;
}

.action-btn {
  flex: 1;
  height: 88rpx;
  border-radius: 16rpx;
  font-size: 32rpx;
  font-weight: 600;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.reject-btn {
  background-color: #F5F5F5;
  color: #666;
}

.reject-btn:active {
  background-color: #EEEEEE;
}

.accept-btn {
  background-color: #E53935;
  color: #fff;
}

.accept-btn:active {
  background-color: #D32F2F;
}
</style>

