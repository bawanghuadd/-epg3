<template>
  <view class="page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="top-nav">
      <view class="back-btn" @click="goBack">
        <text class="back-text">â†</text>
      </view>
      <text class="nav-title">è®¢å•è¯¦æƒ…</text>
      <view class="more-btn" @click="showMore">
        <text class="more-text">â‹¯</text>
      </view>
    </view>

    <scroll-view scroll-y class="content-scroll">
      <!-- è®¢å•çŠ¶æ€å¡ç‰‡ -->
      <view class="status-card">
        <view class="status-icon-wrapper">
          <text class="status-emoji">ğŸ”§</text>
        </view>
        <view class="status-content">
          <text class="status-title">è®¢å•çŠ¶æ€</text>
          <text class="status-text">{{ orderDetail.statusText }}</text>
          <view class="status-time">
            <text class="time-emoji">â°</text>
            <text class="time-text">{{ orderDetail.estimatedTime }}</text>
          </view>
        </view>
      </view>

      <!-- æœåŠ¡è¿›åº¦ -->
      <view class="section">
        <text class="section-title">æœåŠ¡è¿›åº¦</text>
        <view class="timeline">
          <view 
            class="timeline-item" 
            :class="{ completed: step.completed, active: step.active }"
            v-for="(step, index) in orderDetail.timeline" 
            :key="index"
          >
            <view class="timeline-dot-wrapper">
              <view class="timeline-dot"></view>
              <view class="timeline-line" v-if="index < orderDetail.timeline.length - 1"></view>
            </view>
            <view class="timeline-content">
              <text class="timeline-title">{{ step.title }}</text>
              <text class="timeline-time">{{ step.time }}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æœåŠ¡ä¿¡æ¯ -->
      <view class="section">
        <text class="section-title">æœåŠ¡ä¿¡æ¯</text>
        <view class="info-card">
          <text class="info-label">è®¢å•ç¼–å·</text>
          <text class="info-value">{{ orderDetail.orderNo }}</text>
        </view>
        <view class="info-card">
          <text class="info-label">æœåŠ¡ç±»å‹</text>
          <view class="service-tags">
            <view class="service-tag" :class="tag.type" v-for="(tag, index) in orderDetail.serviceTags" :key="index">
              <text>{{ tag.name }}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å®¢æˆ·ä¿¡æ¯ -->
      <view class="section">
        <text class="section-title">å®¢æˆ·ä¿¡æ¯</text>
        <view class="customer-info">
          <view class="customer-row">
            <text class="customer-label">è”ç³»äºº</text>
            <text class="customer-value">{{ orderDetail.customer.name }}</text>
          </view>
          <view class="customer-row">
            <text class="customer-label">è”ç³»ç”µè¯</text>
            <view class="customer-phone">
              <text class="customer-value">{{ orderDetail.customer.phone }}</text>
              <view class="icon-btn" @click="callCustomer">
                <text class="icon-emoji">ğŸ“</text>
              </view>
            </view>
          </view>
          <view class="customer-row">
            <text class="customer-label">æœåŠ¡åœ°å€</text>
            <view class="customer-address">
              <text class="customer-value">{{ orderDetail.customer.address }}</text>
              <view class="icon-btn" @click="navigateToLocation">
                <text class="icon-emoji">ğŸ“</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æœåŠ¡æ—¶é—´ -->
      <view class="section">
        <text class="section-title">æœåŠ¡æ—¶é—´</text>
        <view class="time-info">
          <view class="time-row">
            <text class="time-label">é¢„çº¦æ—¶é—´</text>
            <text class="time-value">{{ orderDetail.serviceTime.scheduled }}</text>
          </view>
          <view class="time-row" v-if="orderDetail.serviceTime.actual">
            <text class="time-label">å®é™…æ—¶é—´</text>
            <text class="time-value">{{ orderDetail.serviceTime.actual }}</text>
          </view>
        </view>
      </view>

      <!-- è´¹ç”¨æ˜ç»† -->
      <view class="section">
        <text class="section-title">è´¹ç”¨æ˜ç»†</text>
        <view class="price-card">
          <view class="price-row">
            <text class="price-label">æœåŠ¡è´¹ç”¨</text>
            <text class="price-value">Â¥{{ orderDetail.pricing.service }}</text>
          </view>
          <view class="price-row" v-if="orderDetail.pricing.material">
            <text class="price-label">ææ–™è´¹ç”¨</text>
            <text class="price-value">Â¥{{ orderDetail.pricing.material }}</text>
          </view>
          <view class="price-row" v-if="orderDetail.pricing.discount">
            <text class="price-label">ä¼˜æƒ é‡‘é¢</text>
            <text class="price-value discount">-Â¥{{ orderDetail.pricing.discount }}</text>
          </view>
          <view class="price-divider"></view>
          <view class="price-row total">
            <text class="price-label">åˆè®¡</text>
            <text class="price-value total">Â¥{{ orderDetail.pricing.total }}</text>
          </view>
        </view>
      </view>

      <!-- è®¢å•å¤‡æ³¨ -->
      <view class="section" v-if="orderDetail.note">
        <text class="section-title">è®¢å•å¤‡æ³¨</text>
        <view class="note-card">
          <text class="note-text">{{ orderDetail.note }}</text>
        </view>
      </view>

      <!-- åº•éƒ¨å ä½ -->
      <view style="height: 180rpx;"></view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-actions">
      <button class="action-btn cancel" @click="handleCancel" v-if="showCancelButton">
        <text>å–æ¶ˆè®¢å•</text>
      </button>
      <button class="action-btn contact" @click="handleContact">
        <text>è”ç³»å®¢æœ</text>
      </button>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'

// è·å–è·¯ç”±å‚æ•°
const orderId = ref('')

// è®¢å•è¯¦æƒ…æ•°æ®
const orderDetail = ref({
  id: 1,
  orderNo: '#20251107001',
  status: 'in_progress',
  statusText: 'æœåŠ¡è¿›è¡Œä¸­',
  estimatedTime: 'é¢„è®¡è¿˜éœ€ 1.5 å°æ—¶å®Œæˆ',
  timeline: [
    {
      title: 'è®¢å•å·²ç¡®è®¤',
      time: '2025-11-07 09:30',
      completed: true,
      active: false
    },
    {
      title: 'å·¥ç¨‹å¸ˆå·²å‡ºå‘',
      time: '2025-11-07 13:45',
      completed: true,
      active: false
    },
    {
      title: 'å·²åˆ°è¾¾ç°åœº',
      time: '2025-11-07 14:20',
      completed: true,
      active: false
    },
    {
      title: 'æœåŠ¡ä¸­...',
      time: 'é¢„è®¡ 16:00 å®Œæˆ',
      completed: false,
      active: true
    },
    {
      title: 'å®¢æˆ·éªŒæ”¶',
      time: '',
      completed: false,
      active: false
    },
    {
      title: 'å®Œæˆæ”¯ä»˜',
      time: '',
      completed: false,
      active: false
    }
  ],
  serviceTags: [
    { name: 'ç”µå·¥æœåŠ¡', type: 'primary' },
    { name: 'è®¡ä»¶å·¥èµ„', type: 'secondary' }
  ],
  customer: {
    name: 'å¼ å…ˆç”Ÿ',
    phone: '138****8888',
    address: 'åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬SOHO T3åº§ 1205å®¤'
  },
  serviceTime: {
    scheduled: '2025-11-07 14:00 - 18:00',
    actual: '2025-11-07 14:20 å¼€å§‹'
  },
  pricing: {
    service: '800',
    material: '0',
    discount: '0',
    total: '800'
  },
  note: 'å®¶é‡Œç©ºè°ƒåˆ¶å†·æ•ˆæœä¸å¥½,éœ€è¦æ£€æŸ¥ç»´ä¿®ã€‚æœ€å¥½åœ¨ä¸‹åˆ2ç‚¹ä»¥åä¸Šé—¨,è°¢è°¢ã€‚'
})

// æ˜¯å¦æ˜¾ç¤ºå–æ¶ˆè®¢å•æŒ‰é’®
const showCancelButton = computed(() => {
  return orderDetail.value.status === 'pending_confirm'
})

onMounted(() => {
  // è·å–è·¯ç”±å‚æ•°
  const pages = getCurrentPages()
  const currentPage = pages[pages.length - 1] as any
  orderId.value = currentPage.$route?.query?.id || '1'
  
  // åŠ è½½è®¢å•è¯¦æƒ…
  loadOrderDetail()
})

// åŠ è½½è®¢å•è¯¦æƒ…
function loadOrderDetail() {
  // TODO: æ ¹æ®orderIdä»APIè·å–è®¢å•è¯¦æƒ…
  console.log('åŠ è½½è®¢å•è¯¦æƒ…:', orderId.value)
}

// è¿”å›
function goBack() {
  uni.navigateBack()
}

// æ˜¾ç¤ºæ›´å¤šæ“ä½œ
function showMore() {
  uni.showActionSheet({
    itemList: ['åˆ†äº«è®¢å•', 'æŠ•è¯‰ä¸¾æŠ¥'],
    success: (res) => {
      if (res.tapIndex === 0) {
        uni.showToast({
          title: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­',
          icon: 'none'
        })
      } else if (res.tapIndex === 1) {
        uni.showToast({
          title: 'æŠ•è¯‰ä¸¾æŠ¥åŠŸèƒ½å¼€å‘ä¸­',
          icon: 'none'
        })
      }
    }
  })
}

// æ‹¨æ‰“å®¢æˆ·ç”µè¯
function callCustomer() {
  uni.showModal({
    title: 'æ‹¨æ‰“ç”µè¯',
    content: `ç¡®è®¤æ‹¨æ‰“ ${orderDetail.value.customer.phone}?`,
    success: (res) => {
      if (res.confirm) {
        uni.makePhoneCall({
          phoneNumber: orderDetail.value.customer.phone.replace(/\*/g, ''),
          fail: () => {
            uni.showToast({
              title: 'æ‹¨å·å¤±è´¥',
              icon: 'none'
            })
          }
        })
      }
    }
  })
}

// å¯¼èˆªåˆ°åœ°å€
function navigateToLocation() {
  uni.openLocation({
    latitude: 39.9942,
    longitude: 116.4764,
    name: 'æœ›äº¬SOHO',
    address: orderDetail.value.customer.address,
    fail: () => {
      uni.showToast({
        title: 'æ‰“å¼€åœ°å›¾å¤±è´¥',
        icon: 'none'
      })
    }
  })
}

// å–æ¶ˆè®¢å•
function handleCancel() {
  uni.showModal({
    title: 'å–æ¶ˆè®¢å•',
    content: 'ç¡®è®¤è¦å–æ¶ˆè¿™ä¸ªè®¢å•å—?',
    success: (res) => {
      if (res.confirm) {
        // TODO: è°ƒç”¨å–æ¶ˆè®¢å•API
        uni.showToast({
          title: 'è®¢å•å·²å–æ¶ˆ',
          icon: 'success'
        })
        setTimeout(() => {
          uni.navigateBack()
        }, 1500)
      }
    }
  })
}

// è”ç³»å®¢æœ
function handleContact() {
  uni.showActionSheet({
    itemList: ['ç”µè¯å®¢æœ', 'åœ¨çº¿å®¢æœ'],
    success: (res) => {
      if (res.tapIndex === 0) {
        uni.makePhoneCall({
          phoneNumber: '400-888-8888',
          fail: () => {
            uni.showToast({
              title: 'æ‹¨å·å¤±è´¥',
              icon: 'none'
            })
          }
        })
      } else if (res.tapIndex === 1) {
        uni.showToast({
          title: 'åœ¨çº¿å®¢æœåŠŸèƒ½å¼€å‘ä¸­',
          icon: 'none'
        })
      }
    }
  })
}
</script>

<style scoped lang="scss">
.page {
  height: 100vh;
  background-color: #f5f5f5;
  display: flex;
  flex-direction: column;
}

// é¡¶éƒ¨å¯¼èˆª
.top-nav {
  background-color: #fff;
  padding: 32rpx 32rpx;
  padding-top: calc(96rpx + env(safe-area-inset-top));
  padding-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1rpx solid #f0f0f0;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  z-index: 1000;
}

.back-btn,
.more-btn {
  width: 44rpx;
  height: 44rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.back-text,
.more-text {
  font-size: 36rpx;
  color: #333;
  font-weight: 500;
}

.nav-title {
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  flex: 1;
  text-align: center;
}

.content-scroll {
  flex: 1;
  padding: 24rpx 32rpx;
  padding-top: calc(176rpx + env(safe-area-inset-top) + 24rpx);
}

// è®¢å•çŠ¶æ€å¡ç‰‡
.status-card {
  background: linear-gradient(135deg, #FF7043 0%, #FF5722 100%);
  border-radius: 24rpx;
  padding: 40rpx;
  margin-bottom: 24rpx;
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 24rpx;
  box-shadow: 0 8rpx 24rpx rgba(255, 87, 34, 0.3);
}

.status-icon-wrapper {
  width: 96rpx;
  height: 96rpx;
  background-color: rgba(255, 255, 255, 0.25);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.status-emoji {
  font-size: 56rpx;
}

.status-content {
  flex: 1;
}

.status-title {
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.9);
  display: block;
  margin-bottom: 8rpx;
}

.status-text {
  font-size: 40rpx;
  font-weight: 700;
  color: #fff;
  display: block;
  margin-bottom: 12rpx;
}

.status-time {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8rpx;
}

.time-emoji {
  font-size: 24rpx;
  opacity: 0.9;
}

.time-text {
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.95);
}

// é€šç”¨section
.section {
  background-color: #fff;
  border-radius: 24rpx;
  padding: 32rpx;
  margin-bottom: 24rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  display: block;
  margin-bottom: 24rpx;
}

// æ—¶é—´è½´
.timeline {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.timeline-item {
  display: flex;
  flex-direction: row;
  gap: 20rpx;
  padding-bottom: 32rpx;
  opacity: 0.5;
}

.timeline-item.completed {
  opacity: 1;
}

.timeline-item.active {
  opacity: 1;
}

.timeline-dot-wrapper {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.timeline-dot {
  width: 24rpx;
  height: 24rpx;
  border-radius: 50%;
  background-color: #E0E0E0;
  border: 4rpx solid #f5f5f5;
  z-index: 1;
}

.timeline-item.completed .timeline-dot {
  background-color: #4CAF50;
}

.timeline-item.active .timeline-dot {
  background-color: #E53935;
  box-shadow: 0 0 0 8rpx rgba(229, 57, 53, 0.15);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 0 8rpx rgba(229, 57, 53, 0.15);
  }
  50% {
    box-shadow: 0 0 0 16rpx rgba(229, 57, 53, 0.1);
  }
}

.timeline-line {
  width: 2rpx;
  flex: 1;
  background-color: #E0E0E0;
  margin-top: 8rpx;
  min-height: 40rpx;
}

.timeline-item.completed .timeline-line {
  background-color: #4CAF50;
}

.timeline-content {
  flex: 1;
  padding-top: 2rpx;
}

.timeline-title {
  font-size: 28rpx;
  color: #333;
  display: block;
  margin-bottom: 8rpx;
  font-weight: 500;
}

.timeline-item.active .timeline-title {
  color: #E53935;
  font-weight: 600;
}

.timeline-time {
  font-size: 24rpx;
  color: #999;
  display: block;
}

// ä¿¡æ¯å¡ç‰‡
.info-card {
  padding: 20rpx 0;
  border-bottom: 1rpx solid #f0f0f0;
}

.info-card:last-child {
  border-bottom: none;
}

.info-label {
  font-size: 26rpx;
  color: #999;
  display: block;
  margin-bottom: 12rpx;
}

.info-value {
  font-size: 28rpx;
  color: #333;
}

.service-tags {
  display: flex;
  flex-direction: row;
  gap: 16rpx;
  flex-wrap: wrap;
}

.service-tag {
  padding: 8rpx 20rpx;
  border-radius: 8rpx;
  font-size: 24rpx;
}

.service-tag.primary {
  background-color: #FFEBEE;
  color: #E53935;
}

.service-tag.secondary {
  background-color: #F5F5F5;
  color: #666;
}

// å®¢æˆ·ä¿¡æ¯
.customer-info {
  display: flex;
  flex-direction: column;
  gap: 24rpx;
}

.customer-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
}

.customer-label {
  font-size: 26rpx;
  color: #999;
  flex-shrink: 0;
  margin-right: 32rpx;
}

.customer-value {
  font-size: 28rpx;
  color: #333;
  text-align: right;
  flex: 1;
}

.customer-phone,
.customer-address {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 16rpx;
  flex: 1;
  justify-content: flex-end;
}

.icon-btn {
  width: 48rpx;
  height: 48rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #F5F5F5;
  border-radius: 50%;
  flex-shrink: 0;
}

.icon-emoji {
  font-size: 24rpx;
}

// æ—¶é—´ä¿¡æ¯
.time-info {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
}

.time-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.time-label {
  font-size: 26rpx;
  color: #999;
}

.time-value {
  font-size: 28rpx;
  color: #333;
}

// è´¹ç”¨æ˜ç»†
.price-card {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
}

.price-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.price-label {
  font-size: 28rpx;
  color: #666;
}

.price-value {
  font-size: 28rpx;
  color: #333;
}

.price-value.discount {
  color: #E53935;
}

.price-divider {
  height: 1rpx;
  background-color: #f0f0f0;
  margin: 8rpx 0;
}

.price-row.total .price-label {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
}

.price-row.total .price-value {
  font-size: 40rpx;
  font-weight: 700;
  color: #E53935;
}

// è®¢å•å¤‡æ³¨
.note-card {
  padding: 24rpx;
  background-color: #FAFAFA;
  border-radius: 12rpx;
}

.note-text {
  font-size: 26rpx;
  color: #666;
  line-height: 1.6;
}

// åº•éƒ¨æ“ä½œæ 
.bottom-actions {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #fff;
  padding: 20rpx 32rpx;
  padding-bottom: calc(20rpx + env(safe-area-inset-bottom));
  border-top: 1rpx solid #f0f0f0;
  display: flex;
  flex-direction: row;
  gap: 20rpx;
  box-shadow: 0 -2rpx 12rpx rgba(0, 0, 0, 0.06);
}

.action-btn {
  flex: 1;
  height: 88rpx;
  border-radius: 16rpx;
  font-size: 28rpx;
  font-weight: 600;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.action-btn.cancel {
  background-color: #F5F5F5;
  color: #666;
}

.action-btn.contact {
  background-color: #E53935;
  color: #fff;
}
</style>

