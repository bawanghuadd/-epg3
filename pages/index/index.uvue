<template>
  <view class="page">
    <view class="content">
      <view class="logo-wrapper">
        <image class="logo" src="/static/logo.png" mode="aspectFill"></image>
      </view>
      <view class="headline">
        <text class="title">å·¥ç¨‹å¸ˆä¸Šé—¨ç»´ä¿®</text>
        <text class="subtitle">ä¸“ä¸šç»´ä¿®æœåŠ¡ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</text>
      </view>

      <view class="welcome">
        <text class="welcome-title">æ¬¢è¿ï¼Œ</text>
        <text class="welcome-subtitle">è¯·æˆæƒç™»å½•ä»¥ç»§ç»­ä½¿ç”¨</text>
      </view>

      <view class="actions">
        <button class="btn primary" @click="handleWeChatLogin" :loading="wechatLoading">
          å¾®ä¿¡ä¸€é”®ç™»å½•
        </button>
        <button
          class="btn secondary"
          open-type="getPhoneNumber"
          @getphonenumber="handlePhoneNumber"
        >
          æˆæƒæ‰‹æœºå·
        </button>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { saveLoginInfo, checkLogin, getPhoneNumber as requestPhoneNumber } from '@/utils/auth'

const wechatLoading = ref(false)
const phoneLoading = ref(false)

// å¼€å‘ç¯å¢ƒæ ‡è¯†
const isDev = true // è®¾ç½®ä¸º false è¿æ¥çœŸå®åç«¯
const debugMode = false // è®¾ç½®ä¸º true å¯æŸ¥çœ‹çœŸå®çš„å¾®ä¿¡ codeï¼ˆå·²å…³é—­ï¼Œæ–¹ä¾¿æµè§ˆé¡µé¢ï¼‰

onMounted(() => {
  // å¦‚æœå·²ç»ç™»å½•ï¼Œç›´æ¥è·³è½¬åˆ°é¦–é¡µ
  if (checkLogin()) {
    uni.reLaunch({
      url: '/pages/home/home'
    })
  }
})

// è¯·æ±‚åç«¯ç™»å½•æ¥å£
async function requestLogin(code: string) {
  try {
    // TODO: æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åç«¯æ¥å£åœ°å€
    const API_BASE_URL = 'https://your-api-domain.com'
    
    const res = await uni.request({
      url: `${API_BASE_URL}/api/auth/wechat-login`,
      method: 'POST',
      data: {
        code: code,
        platform: 'weixin'
      },
      header: {
        'Content-Type': 'application/json'
      }
    })
      
    return res.data
  } catch (error) {
    console.error('è¯·æ±‚ç™»å½•æ¥å£å¤±è´¥:', error)
    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥')
  }
}

// å¾®ä¿¡ä¸€é”®ç™»å½•
async function handleWeChatLogin() {
  if (wechatLoading.value) {
    return
  }
  
  wechatLoading.value = true
  
  try {
    // è°ƒè¯•æ¨¡å¼ï¼šè·å–çœŸå®å¾®ä¿¡ code
    if (debugMode) {
      console.log('ğŸ” è°ƒè¯•æ¨¡å¼ï¼šè·å–çœŸå®å¾®ä¿¡ code')
      
      const loginRes = await uni.login({
        provider: 'weixin',
        onlyAuthorize: true
      })
      
      console.log('âœ… å¾®ä¿¡ Code:', loginRes.code)
      
      // å¼¹çª—æ˜¾ç¤º codeï¼ˆå¯å¤åˆ¶ï¼‰
      uni.showModal({
        title: 'è·å–åˆ°å¾®ä¿¡ Code',
        content: `${loginRes.code}\n\næœ‰æ•ˆæœŸï¼š5åˆ†é’Ÿ\né•¿åº¦ï¼š${loginRes.code.length} ä½`,
        confirmText: 'å¤åˆ¶',
        cancelText: 'å…³é—­',
        success: (res) => {
          if (res.confirm) {
            uni.setClipboardData({
              data: loginRes.code,
              success: () => {
                uni.showToast({
                  title: 'Code å·²å¤åˆ¶',
                  icon: 'success'
                })
              }
            })
          }
        }
      })
      
      wechatLoading.value = false
      return
    }
    
    // å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿç™»å½•
    if (isDev) {
      console.log('å¼€å‘æ¨¡å¼ï¼šä½¿ç”¨æ¨¡æ‹Ÿç™»å½•')
      await simulateLogin()
      return
    }
    
    // ç”Ÿäº§æ¨¡å¼ï¼šçœŸå®å¾®ä¿¡ç™»å½•
    // 1. è·å–å¾®ä¿¡ç™»å½•å‡­è¯
    const loginRes = await uni.login({
      provider: 'weixin',
      onlyAuthorize: true
    })
    
    console.log('å¾®ä¿¡ç™»å½•å‡­è¯:', loginRes.code)
    
    // 2. å°† code å‘é€åˆ°åç«¯æ¢å– token
    const result = await requestLogin(loginRes.code)
    
    if (result.success) {
      // 3. ä¿å­˜ç™»å½•ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
      saveLoginInfo(result.data.token, result.data.userInfo)
      
      // 4. æ˜¾ç¤ºæˆåŠŸæç¤º
      uni.showToast({
        title: 'ç™»å½•æˆåŠŸ',
        icon: 'success',
        duration: 1500
      })
      
      // 5. å»¶è¿Ÿè·³è½¬åˆ°é¦–é¡µ
      setTimeout(() => {
        uni.reLaunch({
          url: '/pages/home/home'
        })
      }, 1500)
    } else {
      throw new Error(result.message || 'ç™»å½•å¤±è´¥')
    }
    
  } catch (error: any) {
    console.error('ç™»å½•é”™è¯¯:', error)
    uni.showToast({
      title: error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      icon: 'none',
      duration: 2000
    })
  } finally {
    wechatLoading.value = false
  }
}

// æ¨¡æ‹Ÿç™»å½•ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
async function simulateLogin() {
  // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
  await new Promise(resolve => setTimeout(resolve, 1000))
  
  // æ¨¡æ‹Ÿç™»å½•æ•°æ®
  const mockToken = 'mock_token_' + Date.now()
  const mockUserInfo = {
    id: '10001',
    nickname: 'æµ‹è¯•ç”¨æˆ·',
    avatar: '',  // ä½¿ç”¨ç©ºå­—ç¬¦ä¸²ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ
    phone: '',
    is_verified: false,  // é»˜è®¤æœªå®åè®¤è¯ï¼Œè§¦å‘åˆå§‹åŒ–æµç¨‹
    vip_level: 0,        // 0-æ™®é€šä¼šå‘˜ 1-VIP 2-é‡‘ç‰Œ
    createTime: Date.now()
  }
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveLoginInfo(mockToken, mockUserInfo)
  
  console.log('æ¨¡æ‹Ÿç™»å½•æˆåŠŸ:', mockUserInfo)
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  uni.showToast({
    title: 'ç™»å½•æˆåŠŸ',
    icon: 'success',
    duration: 1500
  })
  
  // å»¶è¿Ÿè·³è½¬åˆ°é¦–é¡µ
  setTimeout(() => {
    uni.reLaunch({
      url: '/pages/home/home'
    })
  }, 1500)
}

// æˆæƒæ‰‹æœºå·
async function handlePhoneNumber(event: any) {
  if (!event?.detail?.code) {
    uni.showToast({
      title: 'ç”¨æˆ·å–æ¶ˆæˆæƒ',
      icon: 'none'
    })
    return
  }
  
  if (phoneLoading.value) {
    return
  }
  
  phoneLoading.value = true
  
  try {
    console.log('æ‰‹æœºå·æˆæƒç :', event.detail.code)
    
    // å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿæ‰‹æœºå·
    if (isDev) {
      console.log('å¼€å‘æ¨¡å¼ï¼šæ¨¡æ‹Ÿæ‰‹æœºå·æˆæƒ')
      await new Promise(resolve => setTimeout(resolve, 500))
      
      const userInfo = uni.getStorageSync('userInfo') || {}
      userInfo.phone = '138****8888'
      uni.setStorageSync('userInfo', userInfo)
      
      uni.showToast({
        title: 'æ‰‹æœºå·æˆæƒæˆåŠŸ',
        icon: 'success'
      })
      return
    }
    
    // ç”Ÿäº§æ¨¡å¼ï¼šå‘é€åˆ°åç«¯è§£å¯†æ‰‹æœºå·
    const result = await requestPhoneNumber(event.detail.code)
    
    if (result.success) {
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      const userInfo = uni.getStorageSync('userInfo') || {}
      userInfo.phone = result.data.phoneNumber
      uni.setStorageSync('userInfo', userInfo)
      
      uni.showToast({
        title: 'æ‰‹æœºå·æˆæƒæˆåŠŸ',
        icon: 'success'
      })
    } else {
      throw new Error(result.message || 'æˆæƒå¤±è´¥')
    }
  } catch (error: any) {
    console.error('æ‰‹æœºå·æˆæƒé”™è¯¯:', error)
    uni.showToast({
      title: error.message || 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•',
      icon: 'none'
    })
  } finally {
    phoneLoading.value = false
  }
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background: linear-gradient(180deg, #6f7efb 0%, #7f58ff 45%, #7440cd 100%);
  display: flex;
  justify-content: center;
  padding: 80rpx 40rpx 60rpx;
  box-sizing: border-box;
  font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
}

.content {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #fff;
}

.logo-wrapper {
  width: 160rpx;
  height: 160rpx;
  border-radius: 40rpx;
  background-color: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 40rpx;
}

.logo {
  width: 120rpx;
  height: 120rpx;
  border-radius: 24rpx;
}

.headline {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  font-size: 48rpx;
  font-weight: 600;
}

.subtitle {
  display: block;
  margin-top: 12rpx;
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.85);
}

.welcome {
  text-align: center;
  margin-bottom: 50rpx;
}

.welcome-title {
  display: block;
  font-size: 40rpx;
  font-weight: 600;
}

.welcome-subtitle {
  display: block;
  font-size: 28rpx;
  margin-top: 6rpx;
  color: rgba(255, 255, 255, 0.9);
}

.actions {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 24rpx;
  margin-bottom: 40rpx;
}

.btn {
  width: 100%;
  height: 96rpx;
  border-radius: 48rpx;
  font-size: 30rpx;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
}

.btn.primary {
  background-color: #ffffff;
  color: #5c3bce;
  box-shadow: 0 18rpx 40rpx rgba(18, 0, 61, 0.25);
}

.btn.secondary {
  background-color: rgba(255, 255, 255, 0.18);
  color: #ffffff;
  border: 2rpx solid rgba(255, 255, 255, 0.4);
}
</style>
