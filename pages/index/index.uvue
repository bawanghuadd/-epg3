<template>
  <view class="page">
    <view class="content">
      <view class="logo-wrapper">
        <image class="logo" src="/static/logo.png" mode="aspectFill"></image>
      </view>
      <view class="headline">
        <text class="title">å·¥ç¨‹å¸ˆä¸Šé—¨ç»´ä¿®</text>
        <text class="subtitle">ä¸“ä¸šç»´ä¿®æœåŠ¡ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</text>
      </view>

      <view class="welcome">
        <text class="welcome-title">æ¬¢è¿ï¼Œ</text>
        <text class="welcome-subtitle">è¯·æˆæƒç™»å½•ä»¥ç»§ç»­ä½¿ç”¨</text>
      </view>

      <view class="actions">
        <button class="btn primary" @click="handleWeChatLogin" :loading="wechatLoading">
          å¾®ä¿¡ä¸€é”®ç™»å½•
        </button>
        <button
          class="btn secondary"
          open-type="getPhoneNumber"
          @getphonenumber="handlePhoneNumber"
        >
          æˆæƒæ‰‹æœºå·
        </button>
      </view>

      <!-- æ¨¡æ‹Ÿç™»å½•åŒºåŸŸï¼ˆå¼€å‘ç¯å¢ƒï¼‰ -->
      <view class="mock-login-section" v-if="showMockLogin">
        <view class="mock-divider">
          <text class="divider-text">å¼€å‘ç¯å¢ƒ</text>
        </view>
        <view class="mock-buttons">
          <button class="btn mock customer" @click="handleMockLogin('customer')">
            æ¨¡æ‹Ÿå®¢æˆ·ç™»å½•
          </button>
          <button class="btn mock engineer" @click="handleMockLogin('engineer')">
            æ¨¡æ‹Ÿå·¥ç¨‹å¸ˆç™»å½•
          </button>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { isLoggedIn, setToken, setUserInfo, navigateToHome } from '../../utils/auth'
import { wechatLogin, phoneLogin } from '../../utils/api'
import { USER_TYPES, ROUTES } from '../../config'
import { mockLogin } from '../../utils/mock-login'

const wechatLoading = ref(false)
const phoneLoading = ref(false)

// è°ƒè¯•æ¨¡å¼ï¼šè®¾ç½®ä¸º true å¯æŸ¥çœ‹çœŸå®çš„å¾®ä¿¡ code
const debugMode = false

// æ˜¯å¦æ˜¾ç¤ºæ¨¡æ‹Ÿç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
const showMockLogin = ref(true)

// ç”¨æˆ·ç±»å‹æ˜ å°„
const userTypeMap: Record<string, 'engineer' | 'customer'> = {
  'customer': 'customer',
  'engineer': 'engineer'
}

// è½¬æ¢åç«¯æ•°æ®æ ¼å¼ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
function transformUserInfo(backendData: any) {
  return {
    id: String(backendData.userId || ''),
    nickname: backendData.nickname || 'å¾®ä¿¡ç”¨æˆ·',
    avatar: backendData.avatar || '',
    phone: backendData.phone || '',
    user_type: userTypeMap[backendData.userType] || 'customer' as 'engineer' | 'customer',
    is_verified: backendData.isVerified || false,
    vip_level: backendData.role || 0,
    createTime: Date.now()
  }
}

// ä¿å­˜ç™»å½•ä¿¡æ¯å¹¶è·³è½¬
function saveLoginInfoAndNavigate(token: string, backendData: any) {
  const userInfo = transformUserInfo(backendData)
  setToken(token)
  setUserInfo(userInfo)
  
  console.log('ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜:', userInfo)
  
  const message = backendData.isFirstLogin ? 'æ³¨å†ŒæˆåŠŸ' : 'ç™»å½•æˆåŠŸ'
  uni.showToast({
    title: message,
    icon: 'success',
    duration: 1500
  })
  
  setTimeout(() => {
    navigateToHome()
  }, 1500)
}

onMounted(() => {
  // å¦‚æœå·²ç»ç™»å½•ï¼Œæ ¹æ®ç”¨æˆ·ç±»å‹è·³è½¬åˆ°å¯¹åº”é¦–é¡µ
  if (isLoggedIn()) {
    navigateToHome()
  }
})

// å¾®ä¿¡ä¸€é”®ç™»å½•
async function handleWeChatLogin() {
  if (wechatLoading.value) {
    return
  }
  
  wechatLoading.value = true
  
  try {
    // è°ƒè¯•æ¨¡å¼ï¼šè·å–çœŸå®å¾®ä¿¡ code
    if (debugMode) {
      console.log('ğŸ” è°ƒè¯•æ¨¡å¼ï¼šè·å–çœŸå®å¾®ä¿¡ code')
      
      const loginRes = await uni.login({
        provider: 'weixin',
        onlyAuthorize: true
      })
      
      console.log('âœ… å¾®ä¿¡ Code:', loginRes)
      
      // å¼¹çª—æ˜¾ç¤º codeï¼ˆå¯å¤åˆ¶ï¼‰
      uni.showModal({
        title: 'è·å–åˆ°å¾®ä¿¡ Code',
        content: `${loginRes.code}\n\næœ‰æ•ˆæœŸï¼š5åˆ†é’Ÿ\né•¿åº¦ï¼š${loginRes.code.length} ä½`,
        confirmText: 'å¤åˆ¶',
        cancelText: 'å…³é—­',
        success: (res) => {
          if (res.confirm) {
            uni.setClipboardData({
              data: loginRes.code,
              success: () => {
                uni.showToast({
                  title: 'Code å·²å¤åˆ¶',
                  icon: 'success'
                })
              }
            })
          }
        }
      })
      
      wechatLoading.value = false
      return
    }
    
    // ç”Ÿäº§æ¨¡å¼ï¼šçœŸå®å¾®ä¿¡ç™»å½•
    // 1. è·å–å¾®ä¿¡ç™»å½•å‡­è¯
    const loginRes = await uni.login({
      provider: 'weixin',
      onlyAuthorize: true
    })
    
    console.log('å¾®ä¿¡ç™»å½•å‡­è¯:', loginRes)
    
    // 2. è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
    let wechatUserInfo = null
    try {
      const userInfoRes = await uni.getUserProfile({
        desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™'
      })
      wechatUserInfo = userInfoRes.userInfo
    } catch (err) {
      console.log('ç”¨æˆ·æ‹’ç»æˆæƒç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨ code ç™»å½•')
    }
    
    // 3. å°† code å’Œç”¨æˆ·ä¿¡æ¯å‘é€åˆ°åç«¯è¿›è¡Œç™»å½•/æ³¨å†Œ
    const result = await wechatLogin({
      code: loginRes.code,
      nickname: wechatUserInfo?.nickName || '',
      avatar: wechatUserInfo?.avatarUrl || '',
      role: wechatUserInfo?.role ?? 1
    })
    
    // åç«¯è¿”å›ç»“æ„: { code: 0, data: {...}, msg: "..." }
    if (result.code === 0 && result.data) {
      // 4. ä¿å­˜ç™»å½•ä¿¡æ¯å¹¶è·³è½¬
      saveLoginInfoAndNavigate(result.data.token, result.data)
    } else {
      throw new Error(result.msg || 'ç™»å½•å¤±è´¥')
    }
    
  } catch (error: any) {
    console.error('ç™»å½•é”™è¯¯:', error)
    uni.showToast({
      title: error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      icon: 'none',
      duration: 2000
    })
  } finally {
    wechatLoading.value = false
  }
}

// æ¨¡æ‹Ÿç™»å½•
async function handleMockLogin(userType: 'customer' | 'engineer') {
  try {
    await mockLogin(userType, {
      showLoading: true,
      showToast: true,
      autoNavigate: true,
      delay: 800
    })
  } catch (error: any) {
    console.error('æ¨¡æ‹Ÿç™»å½•å¤±è´¥:', error)
    uni.showToast({
      title: error.message || 'ç™»å½•å¤±è´¥',
      icon: 'none'
    })
  }
}

// æˆæƒæ‰‹æœºå·ï¼ˆåŒæ—¶è¿›è¡Œç™»å½•/æ³¨å†Œï¼‰
async function handlePhoneNumber(event: any) {
  if (!event?.detail?.code) {
    uni.showToast({
      title: 'ç”¨æˆ·å–æ¶ˆæˆæƒ',
      icon: 'none'
    })
    return
  }
  
  if (phoneLoading.value) {
    return
  }
  
  phoneLoading.value = true
  
  try {
    console.log('æ‰‹æœºå·æˆæƒç :', event.detail.code)
    
    // è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    let wechatUserInfo = null
    try {
      const userInfoRes = await uni.getUserProfile({
        desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™'
      })
      wechatUserInfo = userInfoRes.userInfo
    } catch (err) {
      console.log('ç”¨æˆ·æ‹’ç»æˆæƒç”¨æˆ·ä¿¡æ¯')
    }
    
    // è·å–å¾®ä¿¡ç™»å½• code
    const loginRes = await uni.login({
      provider: 'weixin',
      onlyAuthorize: true
    })
    
    // è°ƒç”¨åç«¯æ¥å£è¿›è¡Œç™»å½•/æ³¨å†Œ
    const result = await phoneLogin({
      phoneCode: event.detail.code,
      wechatCode: loginRes.code,
      userInfo: wechatUserInfo
    })
    
    // åç«¯è¿”å›ç»“æ„: { code: 0, data: {...}, msg: "..." }
    if (result.code === 0 && result.data) {
      // ä¿å­˜ç™»å½•ä¿¡æ¯å¹¶è·³è½¬
      saveLoginInfoAndNavigate(result.data.token, result.data)
    } else {
      throw new Error(result.msg || 'æˆæƒå¤±è´¥')
    }
  } catch (error: any) {
    console.error('æ‰‹æœºå·æˆæƒé”™è¯¯:', error)
    uni.showToast({
      title: error.message || 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•',
      icon: 'none'
    })
  } finally {
    phoneLoading.value = false
  }
}
</script>

<style scoped lang="scss">
.page {
  min-height: 100vh;
  background: linear-gradient(180deg, #6f7efb 0%, #7f58ff 45%, #7440cd 100%);
  display: flex;
  justify-content: center;
  padding: 80rpx 40rpx 60rpx;
  box-sizing: border-box;
  font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
}

.content {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #fff;
}

.logo-wrapper {
  width: 160rpx;
  height: 160rpx;
  border-radius: 40rpx;
  background-color: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 40rpx;
}

.logo {
  width: 120rpx;
  height: 120rpx;
  border-radius: 24rpx;
}

.headline {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  font-size: 48rpx;
  font-weight: 600;
}

.subtitle {
  display: block;
  margin-top: 12rpx;
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.85);
}

.welcome {
  text-align: center;
  margin-bottom: 50rpx;
}

.welcome-title {
  display: block;
  font-size: 40rpx;
  font-weight: 600;
}

.welcome-subtitle {
  display: block;
  font-size: 28rpx;
  margin-top: 6rpx;
  color: rgba(255, 255, 255, 0.9);
}

.actions {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 24rpx;
  margin-bottom: 40rpx;
}

.btn {
  width: 100%;
  height: 96rpx;
  border-radius: 48rpx;
  font-size: 30rpx;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
}

.btn.primary {
  background-color: #ffffff;
  color: #5c3bce;
  box-shadow: 0 18rpx 40rpx rgba(18, 0, 61, 0.25);
}

.btn.secondary {
  background-color: rgba(255, 255, 255, 0.18);
  color: #ffffff;
  border: 2rpx solid rgba(255, 255, 255, 0.4);
}

/* æ¨¡æ‹Ÿç™»å½•æ ·å¼ */
.mock-login-section {
  width: 100%;
  margin-top: 60rpx;
  padding-top: 40rpx;
}

.mock-divider {
  position: relative;
  text-align: center;
  margin-bottom: 30rpx;
}

.mock-divider::before,
.mock-divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: 30%;
  height: 1rpx;
  background-color: rgba(255, 255, 255, 0.3);
}

.mock-divider::before {
  left: 0;
}

.mock-divider::after {
  right: 0;
}

.divider-text {
  display: inline-block;
  padding: 0 20rpx;
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.7);
  background-color: transparent;
}

.mock-buttons {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
}

.btn.mock {
  height: 80rpx;
  font-size: 28rpx;
  background-color: rgba(255, 255, 255, 0.12);
  color: #ffffff;
  border: 1rpx solid rgba(255, 255, 255, 0.3);
  box-shadow: none;
}

.btn.mock.customer {
  border-left: 6rpx solid #4CAF50;
}

.btn.mock.engineer {
  border-left: 6rpx solid #FF9800;
}

.btn.mock:active {
  opacity: 0.7;
}
</style>
